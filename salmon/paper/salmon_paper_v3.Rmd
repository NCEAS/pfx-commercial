---
title: 'Reduced diversity and increased specialization of Alaska salmon fishermen:
  effects on variation in individual revenues'
author: "Eric, Sean, Ole, Rich, Jordan, Jen, Alan, Milo, Ben"
date: ''
output:
  pdf_document:
    fig_caption: yes
  html_document: default
  word_document: default
bibliography: CatchPortfolios_salmon.bib
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE)
library(knitr)
library(tidyverse)
library(reshape2)
library(date)
library(mgcv)
library(gridExtra)
library(zoo)
library(rstan)
library(ggrepel)
modelname = "model-linear" # model-linear-nointeractions
```

## Abstract
\setlength\parindent{24pt}

On a large scale, individual fishers may experience positive outcomes from diversifying their catches; examples include reduced year-to-year variability in annual revenue and increases in average revenue. Fishers can increase their species diversity by owning a permit that allows multiple species to be targeted, or by owning multiple permits. External forces such as management regulations (limited entry,  catch shares), the number of permits available, or market forces (permit or fish prices) may disincentive individuals to hold multiple permits. Thus, individuals holding a single permit may only be able to increase species diversity within the confines of their permit (longer fishing seasons, broader spatial area). Using a 40 year dataset of individual salmon fishers in Alaska, we develop new models for understanding how the effects of diversification have changed through time. These changes allow us to compare patterns across regions and gear, as well as better understand how external forces have changed incentives for diversifying (hatchery production, market forces, EVOS). 

## Introduction

[broader paragraph on diversification with extensions -- somewhat depends on journal, ]

Previous analyses have largely focused on patterns of diversification across ecosystems and the benefits to adopt more or less diverse fishing strategies [@kasperski2013; @anderson_benefits]. Fisheries in Alaska have been studied extensively, because they are one of the most productive seafood regions in the world (both by landed weight, and revenue [@officeofscienceandtechnology2016], FAO cite) and they allow individuals to adopt a wide range of fishing strategies. [@anderson_benefits] defined strategies as a permit or collection of permits held by single individuals. While adding new permits allows fishers to increase species diversity, few individual permits allow individuals to harvest more than one species (examples of single-species permits in the Gulf of Alaska include halibut, sablefish, herring, crab, shellfish, shrimp, sea cucumber). Some exceptions to these single species permits include participants in federally managed groundfish fisheries and participants in state managed salmon fisheries.  
  
Understanding the effects of species diversification on salmon fishers is particularly important, as the number of salmon specialists (defined as fishers holding a single salmon permit) has increased over the last 30 years as a fraction of the total [@anderson_benefits]. For these limited entry salmon fisheries, general trends since the early 2000s are that that more people are participating, landings are increasing, revenue is level or increasing slightly, and effective species diversity is declining over time (Fig. 1; Figs. A1-A4). Across different salmon fisheries, there appears to be little correlation between diversity and revenue, though fisheries cluster similarly by gear on the risk - return axes (Fig. 2). In terrestrial agriculture, there are numerous examples where diversification may affect the mean or CV of revenue, but not both [@purdy1997], and the same result may be true for salmon fishers. Further, the costs or benefits of diversification may be variable over time.  
  
Five species of salmon are harvested in Alaska waters (Chinook [*Oncorhynchus tshawytscha*], chum [*O. keta*], pink [*O. gorbuscha*], sockeye [*O. nerka*], coho [*O. kisutch*]), and the ability of individual salmon fishers to diversify across species is in part a function of geography and fishing gears. For example, salmon may be caught with purse seine gear (n = 6 areas), drift gillnets (5 areas), or set gillnets (12 areas). Other gears include beach seine and troll gears (though these are generally restricted to Kodiak and Southeast Alaska, respectively). While some of these combinations of gears and areas allow fishers to diversify, there are many examples of permits where the catch is dominated by a single species. Perhaps the best examples include fisheries that target sockeye salmon (e.g. Bristol Bay set and drift gillnet fisheries). For these fisheries, specialization is associated with higher revenue and reduced CV in year-to-year revenue [@anderson_benefits].  

The benefits or costs of catch diversification for fishermen are affected by a number of exogenous drivers, including competition from markets producing farmed salmon, consolidation of salmon buyers, marketing, prices, new processing technology [@knapp_trends]. Following price declines in the 1990s and early 2000s [@adfg2007], many of these factors have been positive for salmon fishermen (increasing trends in prices and catches, Fig. A8-A9). In contrast, the late 1980s - early 1990s experienced high abundance and low prices (in part due to collapses of foreign currencies). Perhaps one of the largest changes affecting the availability or incentives for fishermen to diversify has been the increase in the production of hatchery fish. The modern era of Alaska’s large-scale hatchery program began in the late 1970s [@stopha2016; @ward_evaluating], with substantial increases in hatchery production during the 1980s following low returns [@mahnken1998; @leber2008]. Many of these hatchery programs increased production to stabilize the variability of salmon catches [@hilborn2001a], though these programs may also have negative impacts on wild production [@wertheimer2005; @ruggerone2015]. The intra- and inter-specific effects of large scale hatchery programs has been debated [@hilborn2001a; @hilborn1992a; @wertheimer2001; @heard_hatchery], but the effects of hatcheries have largely been focused on ecological interactions of aggregate yield to the fishery [@leber2008] or economic impacts [@boyce1993], rather than to variability experienced by fisheries or individual fishermen. Understanding the role salmon have in buffering or stabilizing fishing revenues is critical given the responses of salmon to variable environments [@mueter2002; @schindler2010].  

The objectives of our analysis are to (1) evaluate long term trends in stability and to evaluate whether hatchery production has increased stability, and (2) to better understand the effects of diversification on single-permit salmon holders by extending the time series models of individual revenues used by [@anderson_benefits] to include time-varying effects. These time-varying effects of diversification will allow us to compare temporal trends across regions and identify periods when having diverse catch portfolio was most beneficial.  

## Methods

### Data  
  
We obtained fisheries landings and revenue data for all permit holders in Alaska from 1985-2016 from the Commercial Fisheries Entry Commission (CFEC). Reported gross earnings (revenue) associated with each fish ticket were adjusted for inflation by converting all revenues too 2009 USD. Each fish ticket was associated with both a vessel and individual fisher, and because of our focus on individuals, we aggregated data by individuals to generate annual summaries of catch diversity and revenue. Because our modeling focus involves estimating time varying effects of diversification, we limited our analysis to salmon fisheries with species diversity > 1 (omitting fisheries such as the Bristol Bay gillnet fisheries that specialize on sockeye salmon). To better understand the influence of changing hatchery production, we also restricted fisheries to those that have been influenced by hatchery salmon production. 

```{r, echo=FALSE}
m = matrix("", 6, 3)
m[1,] = c("S01A", "Purse Seine", "Southeast Alaska")
m[2,] = c("S01E", "Purse Seine", "Prince William Sound")
m[3,] = c("S01K", "Purse Seine", "Kodiak")
m[4,] = c("S01M", "Purse Seine", "Alaska Peninsula")
m[5,] = c("S03A", "Gillnet", "Southeast Alaska")
m[6,] = c("S03E", "Gillnet", "Prince William Sound")
colnames(m) = c("Fishery (permit)", "Gear", "Region")
kable(m)
```

### Has increased hatchery production stabilized Alaskan salmon fisheries?
  
To understanding long term change in variability of Alaska salmon fisheries, it is important to understand how hatchery production has affected the mean revenue and variability in revenue. For consistency with previous work, we examined the stability in the catch (weight of salmon species [@hilborn2001a; @knapp2007], rather than revenue. Within each region in our analysis (PWS, Southeast, Kodiak, Alaska Peninsula), we used the hatchery contribution to the Common Property Commercial Harvest as the predictor variable, and total harvest as the response. These quantities are reported by region ([@stopha2016]; Fig. 3), but not at the level of fisheries or individuals. Because reporting was not done separately for the Kodiak and Alaska Peninsula regions until after 1995, we grouped these areas into a single region. 

To examine the effects of hatchery production on stability, we used a hierarchical variance function regression model. Variance function models (or heteroscedastic regression models, [@smyth1989]) are typically regression models that also allow covariates to be included (similar to performing sequential regressions on the mean and residuals [@western2009]). We modeled the mean catch of each species in each region as an AR(1) process, $$E[{ Y }_{ s,f,t }]={ Y }_{ s,f,t-1 }+{ b }_{ s,f }{ X }_{ s,f,t }$$ where ${ Y }_{ s,f,t-1 }$ is the observed catch of species *s* in region *f* in the previous time step, ${ b }_{ s,f }$ is an estimated coefficient relating hatchery influence to the mean catch, and ${ X }_{ s,f,t }$ is the change in proportion of hatchery contribution to the total catch for species *s* in between times *t* and *t-1*. We used the difference in hatchery contribution, rather than raw values because the response variable was also first differenced. The hatchery effect coefficients were modeled hierarchically, and assumed that ${ b }_{ s,f }\sim N\left( { u }_{ b },{ \sigma  }_{ b } \right)$, where ${ u }_{ b }$ and ${ \sigma  }_{ b }$ represent the location and scale hyperparameters.

To incorporate potential hatchery effects in the variability of the system, the second component of our model included a hierarchical component on the process variance terms, $$log\left( { \sigma  }_{ s,f,t } \right) ={ g  }_{ 0,s,f }+{ g  }_{ 1,s,f }{ X }_{ s,f,t }$$ where ${ g  }_{ 0,s,f }$ represents an estimated intercept unique to each region and species, and ${ g  }_{ 1,s,f }$ represents a region and species specific slope. The covariate ${ X }_{ s,f,t }$ is identical to that used in the mean model. We included the intercepts { g  }_{ 0,s,f } as fixed effects (representing differences by species) and again modeled the hatchery effect as hierarchical, ${ g }_{ 1,s,f }\sim N\left( { u }_{ g },{ \sigma  }_{ g } \right)$. The observed data were log-transformed and linked to the predicted mean and standard deviation with a normal likelihood, $ln\left( { Y }_{ s,f,t } \right) \sim N\left( E\left[ ln\left( { Y }_{ s,f,t } \right)  \right] ,{ \sigma  }_{ s,f,t } \right)$. 

We focued inference on the slopes of the fraction of hatchery contribution to the total catch, ${ g  }_{ 1,s }$. To allow for comparison across regions and scales of data, we converted these estimates to effect sizes, by calculating ${ \kappa  }_{ s }=ln\left( \frac { { g }_{ 0,s }+{ \left( 1/3 \right) \cdot g }_{ 1,s } }{ { g }_{ 0,s } }  \right)$. The log ratio of these effect sizes represent the approximate natural log of the percent change in the standard deviation resulting from a change in the hatchery contribution of zero to 10% of the catch. 95% credible intervals were generated by repeating this calculation for each MCMC draw, and taking the quantiles of the resulting distribution. 

### Have effects of diversification changed over time for individual salmon fishers?

Because we were only interested in single permit fisheries, we applied a simplified version of the CFEC data filtering steps described in [@anderson_benefits]. Individual trip-level catch and revenue data 1975-2016 were aggregated to annual data for each fisher, and to clarify our comparison across fisheries we retained individual fishers who only participated in one fishery in a year (Table 1). Annual revenues were log-transformed to make the data approximately normally distributed; to avoid complications in modeling individual switching permits, we only included pairs of years for a given person where they did not change permits (e.g. didn’t change fisheries between two years). [@anderson_benefits] implemented a hierarchical Bayesian time series model that incorporated group level predictors and individual covariates (diversity of catch, days fished) to simultaneously affect the mean and the variance of revenue for individual fishers. This model also included random intercepts by fishery and year, allowing all permit holders in a given year to experience common fluctuations (external drivers including price changes, fluctuations in fish population abundance, or environmental disasters such as EVOS). 

To ask how benefits of diversification may have changed over time for salmon fisheries in Alaska, we extend the model of [@anderson_benefits] to include time-varying random effects in the slope coefficients of diversification. We define the variables $\Delta { S }_{ t }=\log\left( { S }_{ t }/{ S }_{ t-1 } \right)$ to represent the percent change in species diversity of the catch between years and $\Delta { D }_{ t }=\log\left( { D }_{ t }/{ D }_{ t-1 } \right)$ to represent the percent change in fishing effort (days fished) between years. The model for the expected log revenue of individual *i* in year *t*, $$\widehat { \log\left( { R }_{ i,t } \right)  } ={ B }_{ 0,j,t }+{ B }_{ 1,j,t }\cdot \Delta S_{ i,t }+{ B }_{ 2,j,t }\cdot \left( \Delta S_{ i,t }\cdot { S }_{ i,t-1 } \right) +{ B }_{ 3,j }\cdot \Delta D_{ i,t }+\log\left( { R }_{ i,t-1 } \right) $$, where *j* subscripts the salmon permit (Table 1). We model the time-varying permit specific intercepts as random and exchangeable across years, ${ B }_{ 0,j,t }\sim \mathrm{Normal}\left( { u }_{ { B }_{ 0 } },{ \sigma  }_{ { B }_{ 0 } } \right)$. The term ${ B }_{ 1,j,t }$ represents the permit level random effect of diversifying species. Our model extends that of [@anderson_benefits] to include the interaction terms $\Delta S_{ t }\cdot { S }_{ t-1 }$ which allow the effect of diversification to be dependent on the previous level of diversification. We assume this relationship is linear, and the coefficients ${ B }_{ 1,j,t }$ and ${ B }_{ 2,j,t }$ allow this to vary by permit and through time. The flexibility in these terms allows the benefit of increasing species diversity to be positive in some years (generalizing benefits revenue), negative in other years (specializing benefits revenue) and neutral in other years (revenue is independent of alterations to catch composition). We constrain the random effects associated with diversification to be modeled as autoregressive processes with shared variances across strategies, for example: ${ B }_{ 1,j,t }\sim \mathrm{Normal}\left( { B }_{ 1,j,t-1 },{ \sigma  }_{ { B }_{ 1 } } \right)$. Like [@anderson_benefits] we also allow changing effort (measured as percent change in days fished) ${ B }_{ 4,j }$ to vary by strategy, but we do not allow this effect to vary through time. Finally, the term $\log\left( { R }_{ i,t-1 } \right)$ is included as an offset [@anderson_benefits]. 

Like [@anderson_benefits], we also included all of the above covariates in the variance model. We assumed the residuals from the mean model described above to be normally distributed, $$\log\left( { R }_{ i,t } \right) \sim \mathrm{Normal}\left( \widehat { \log\left( { R }_{ i,t } \right)  } ,\widehat { { \sigma  }_{ i,t } }  \right) $$. While conventional hierarchical linear regression assumes variances to be constant or shared by grouping variables, we also included fixed and random covariates, making the model akin to variance function regression or stochastic volatility models [@smyth1989; @western2009]. Using the same notation as for the mean, we can express the log standard deviation as $$\widehat { \log\left( { \sigma  }_{ i,t } \right)  } ={ G }_{ 0,j }+{ G }_{ 1,j,t }\cdot \Delta S_{ i,t }+{ G }_{ 2,j,t }\cdot \left( \Delta S_{ i,t }\cdot { S }_{ i,t-1 } \right) +G_{ 3,j }\cdot \Delta D_{ i,t }$$. Unlike the linear model for the mean, we did not include an offset term. Further, we constrained the variance intercepts ${ G }_{ 0,j }$ to be temporally constant by strategy, instead of the dynamic nature of the intercepts in the mean model. Like the mean model, the random effects were constrained to be autoregressive, ${ G }_{ 1,j,t }\sim \mathrm{Normal}\left( { G }_{ 1,j,t-1 },{ \sigma  }_{ { G }_{ 1 } } \right)$, and covariates associated with days fished and species diversity were included as predictors. 

### Estimation  

Estimation for both sets of models was done in a Bayesian framework using R [@rcoreteam2016] and the package 'rstan', implementing Markov chain Monte Carlo (MCMC) using the No-U Turn Sampling (NUTS) algorithm in Stan [@hoffman2014]. Code to replicate our analysis, including additional diagnostics plots, and additional models is available at [https://github.com/NCEAS/pfx-commercial/tree/master/salmon].

## Results

Across species and scales of data (regions, fisheries, average fishers) we found no consistent support for the hypothesis that salmon catches have been stabilized by hatchery production. When total catches are aggregated across fisheries in the four regions in our analysis, we estimate generally positive effects of increased hatchery production on year-to-year variability in catches (Fig. 4). Other than Chinook salmon, estimates (+/- standard errors) are positive for all species in PWS and Southeast Alaska (Fig. 4). When we examine the same effects at finer scales (individual fisheries, or average fishers), the standard errors generally increase, and effects become weaker in magnitude. Some of the estimated effects switch signs entirely -- for example, hatchery production of chum salmon is estimated to have a positive effect on variability in catches in Prince William Sound, but at the level of fisheries or average fishers, increased contributions of hatchery chum salmon appear to reduce variability (Fig. 4). Other effect sizes appear consistent across scales of data; for example increased sockeye salmon in PWS is expected to increase year-to-year variability across fisheries, within the seine and gillnet fisheries (S01E, S03E) and for average fishers (Fig. 4). 

Our model of changing effects of diversification over time suggests that as diversity in these six fisheries have declined over time (Figs. A3-A4), higher revenue is associated with increased specialization (Fig. 5). The negative estimated effects on mean revenue of increasing diversity implies that for the majority of these fisheries in most years, revenue increases when individuals specialize, rather than diversify. Though gillnet fisheries in Southeast Alaska and Prince William Sound have also had reduced benefits of diversifying, each fishery had several periods where it was more profitable to increase catch diversity (mid 1980s-early 1990s for Southeast Alaska, mid-1990s for PWS). With the exception of the Southeast Alaska seine fishery (S01A) in recent years, the negative trends in these estimated effects for most fisheries suggest that the benefits of specializing on revenue have also increased over time. 

[Maybe tie in to Anderson et al.] We found little support for increasing catch diversity reducing variability in revenue for most fisheries (Fig. A5). For seine fisheries in Southeast Alaska and Prince William Sound, there have been periods over the last several decades where diversification has increased variability, but this effect has been strongest over the most recent decade (Fig. A5). Perhaps the only example of a fishery where individuals have seen reduced variability from increasing catch diversity is the Kodiak seine fishery (this effect is strongest in the 1990s and last 5 years). While these effects of diversifying are near zero for most fisheries and don't exhibit a long term trend, an exception is the PWS seine fishery, which appears to have increasing risk associated with diversifying over the time series (Fig. A5).

## Discussion

Understanding the mechanisms responsible for trends or variability in the revenue of individuals whose incomes are dependent on natural resources is important for coupled social-ecological systems, because their income variability is typically greater than the larger population [@mishra2002]. There are a number of ways that fishers in particular may reduce their exposure to risk; examples include holding permits that allow multiple species to be targeted, or buying multiple single-species permits to increase the number of species in their catch portfolio [@anderson_benefits; @kasperski2013]. Just as [@anderson_benefits] found that catch diversity in Alaska was decreasing over time as a greater fraction of the fisher population held single salmon permits, we found within-fishery declines in catch diversity for the six fisheries included in our analysis.

As catch diversity has declined, average revenues have remained relatively flat, but average landed weight has increased over the last 40 years. In other words, fishers have had to catch more to yield the same revenue, and their catches tend to be driven by 1 or 2 species. Like in other fisheries, the ability of fishers to diversify may be largely beyond their control. Options for diversification include fishing in different periods of the season (e.g. fishing earlier in the year in the PWS seine fishery to target chum salmon), or fishing in different areas to increase catch diversity. For example in the PWS seine fishery, individuals are generally confied to areas where pink and chum salmon are present, while gillnet fishers may fish in areas with all five species of salmon present (Rich can provide a citation for the PWS management plan).

Tradeoffs between specialization and diversification may also be found in case studies of terrestrial agriculture. For small scale farmers, increasing crop diversity may increase revenue and stabilize year-to-year income variability [@difalco2003]. At larger scales or in the developed world, however, the incentives for diversification may be different. In the United States and Canada for example, crop diversity has declined since the late-1970s [@aguilar2015; @bradshaw2004]; some of the factors responsible include changing national policies, technology, and increased demand from other parts of the world (e.g. increased U.S. production of soybeans to meet demand from Asia). Shifts from more diverse high value crops to specializing on high-volume low-value crops such as cereals may have analogs for salmon fishermen in low value species with rapid life histories (pink and chum salmon).  

[Rich: maybe look at PWS pink salmon crash in 1992/1993: Pacific Salmon & their Ecosystems: Status and Future Options. EW: pink harvest generally falls from 89/90 to early 90s. It's a little of a chicken and egg problem too - because by the early 90s hatchery production was 75% of the total pink catch and also declined a little bit. From the CV perspective, the pink crash may be synchronizing -- stability was increased because there were several back to back bad years]
[Jordan: So the Copper River salmon marketing ramped up in about 1983. I wonder if we could see a steady increase in value or movement towards sockeye in the early years of the data set. EW: Fig 3 largely shows the pattern in those early years -- it ramps up in PWS, but is less steep than for say chum] 
  
- In terms of participation, why did people drop out in 2000 in SEAK and Alaska Peninsula, but not in PWS? PWS largely seems like a boutique fishery on the Copper River -- which includes a qualtiy component (Copper River at forefront) and a timing issue relative to the rest of the Gulf of Alaska populations (buffers against market impacts). In addition, there are many indications that costs have increased over time as a result of requirements by fish buyers for fish of higher quality (refrigerated sea water, ice, increased handling time, more expensive vessels) more expensive permits, etc.  

- Prices are generally synchronous for all spp (especially coho/chum/pink), and have increased at a faster rate compared to chum and pink salmons since 2000 (Fig A8-A9). We're also seeing a trend toward greater synchrony between species (Fig A11-A12, A14). Projecting future prices is notably complex [@knapp_trends]. Synchrony in prices may largely be function of marketing, improved product, freezing, etc.  

- We're seeing increased specialization within permits. People in PWS are trending toward increased specialization on pink salmon. People in SEAK trending toward increased specialization on chum. Both of these are switches from higher value species (sockeye, chum) to lower value species. Both pink and chum have higher variability in year to year returns than sockeye.  

- The decisions to implement a hatchery program for a given species has economic consequences for overall revenue and the variability of that revenue to fishers and other participants. Salmon that have complex life histories in the ocean phase of their life cycle (sockeye and possibly chum salmon) may have an inherent portfolio that buffers against large annual swings in abundance compared to pink and coho salmon. Also, high-value species may experience less annual fluctuation than lower value species.  

- For small scale farmers, economists have often wondered why farmers don't diversify more. Diversification can be profitable, but in the short term risky or expensive. Bigger than cost seems to be the risk [@karlan2012]

\break  
  
```{r fig1, echo=FALSE, fig.pos="placeHere", fig.cap="Trends in participation, landed catch, mean annual revenue, and effective species diversity for eight selected salmon fisheries. [EW notes: weight per person increasing more than revenue. Species diversity for most fisheries declining]"}
# trends in participation, 
cfec_all = readRDS("../../portfolio/data-generated/salmon_data_for_paper.rds")
people = group_by(cfec_all, p_fshy, year) %>% 
  summarize(n = length(unique(p_holder))) %>% 
  filter(substr(p_fshy,1,1)=="S")
people$p_fshy = paste0(substr(people$p_fshy,1,1), substr(people$p_fshy,3,5))
names(people)[which(names(people)=="p_fshy")]="Permit"

people2 = people[people$Permit%in%c("S01K","S01M","S01E","S01A","S03A","S03E","S03T","S05B"),]
people2$Permit[which(people2$Permit=="S01K")] = "Kodiak-seine"
people2$Permit[which(people2$Permit=="S01M")] = "AKP-seine"
people2$Permit[which(people2$Permit=="S01E")] = "PWS-seine"
people2$Permit[which(people2$Permit=="S01A")] = "SEAK-seine"
people2$Permit[which(people2$Permit=="S03A")] = "SEAK-gillnet"
people2$Permit[which(people2$Permit=="S03E")] = "PWS-gillnet"
people2$Permit[which(people2$Permit=="S03T")] = "BB-gillnet"
people2$Permit[which(people2$Permit=="S05B")] = "State-troll"

g1 = ggplot(people2, aes(year, log10(n), color = Permit)) + geom_line() + ylab("Log10 unique people") + xlab("Year") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

# trends in landed weight - metric tons
#weight_by_species = group_by(cfec_all[cfec_all$p_fshy %in% c("S 01A", "S 01E", "S 01K", "S 01M", "S 03A", "S 03E") & cfec_all$spec %in% c("CHNK","COHO","CHUM","PINK","SOCK"), ], p_fshy, year, spec) %>% 
#summarize(w = sum(g_pounds,na.rm=T) * 0.000453592) %>% 
#filter(substr(p_fshy,1,1)=="S")
#saveRDS(weight_by_species, "../../portfolio/data-generated/weight_data_by_species_fishery.rds")
#weight_by_species_people = left_join(weight_by_species, people)
#saveRDS(weight_by_species_people, "../../portfolio/data-generated/weight_data_by_species_people.rds")

# also calculate for each person, the number of unique permits held per year
#people1 = group_by(cfec_all, year, p_holder) %>% 
#  summarize(n = length(unique(p_fshy))) %>% 
#  filter(n==1)
#people1 = left_join(people1, cfec_all) %>% 
#  filter(p_fshy %in% c("S 01A", "S 01E", "S 01K", "S 01M", "S 03A", "S 03E")) %>% 
#  filter(spec %in% c("CHNK","COHO","PINK","SOCK","CHUM"))
#people1 = group_by(people1, p_holder, year, p_fshy, spec) %>% 
#  summarize(w = sum(g_earn)) %>% 
#  group_by(p_fshy, year, spec) %>% 
#  summarize(w = mean(w, na.rm=T))
#saveRDS(people1, "../../salmon/data-generated/weight_data_by_species_people2.rds")

# trends in landed weight - metric tons
weight = group_by(cfec_all, p_fshy, year) %>% 
  summarize(w = sum(g_pounds,na.rm=T) * 0.000453592) %>% 
  filter(substr(p_fshy,1,1)=="S")
weight$p_fshy = paste0(substr(weight$p_fshy,1,1), substr(weight$p_fshy,3,5))
names(weight)[which(names(weight)=="p_fshy")]="Permit"

weight = left_join(weight, people)

weight2 = weight[weight$Permit%in%c("S01K","S01M","S01E","S01A","S03A","S03E","S03T","S05B"),]
weight2$Permit[which(weight2$Permit=="S01K")] = "Kodiak-seine"
weight2$Permit[which(weight2$Permit=="S01M")] = "AKP-seine"
weight2$Permit[which(weight2$Permit=="S01E")] = "PWS-seine"
weight2$Permit[which(weight2$Permit=="S01A")] = "SEAK-seine"
weight2$Permit[which(weight2$Permit=="S03A")] = "SEAK-gillnet"
weight2$Permit[which(weight2$Permit=="S03E")] = "PWS-gillnet"
weight2$Permit[which(weight2$Permit=="S03T")] = "BB-gillnet"
weight2$Permit[which(weight2$Permit=="S05B")] = "State-troll"

g2 = ggplot(weight2, aes(year, log10(w/n), color = Permit)) + geom_line() + ylab("Log10 tons per person") + xlab("Year") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

# trends in revenue
dat.annual = readRDS(file="../../portfolio/data-generated/salmon-annual-for-modeling.rds")
dat.annual = group_by(dat.annual[which(dat.annual$strategy_permit %in% c("S01A", "S01E", "S01K", "S01M", "S03A", "S03E", "S03T", "S05B")),], year, strategy_permit) %>% 
  summarize(meanrev = mean(revenue), meandiv = mean(specDiv))
names(dat.annual)[which(names(dat.annual)=="strategy_permit")]="Permit"
dat.annual = left_join(dat.annual, weight)

dat.annual2 = dat.annual[dat.annual$Permit%in%c("S01K","S01M","S01E","S01A","S03A","S03E","S03T","S05B"),]
dat.annual2$Permit[which(dat.annual2$Permit=="S01K")] = "Kodiak-seine"
dat.annual2$Permit[which(dat.annual2$Permit=="S01M")] = "AKP-seine"
dat.annual2$Permit[which(dat.annual2$Permit=="S01E")] = "PWS-seine"
dat.annual2$Permit[which(dat.annual2$Permit=="S01A")] = "SEAK-seine"
dat.annual2$Permit[which(dat.annual2$Permit=="S03A")] = "SEAK-gillnet"
dat.annual2$Permit[which(dat.annual2$Permit=="S03E")] = "PWS-gillnet"
dat.annual2$Permit[which(dat.annual2$Permit=="S03T")] = "BB-gillnet"
dat.annual2$Permit[which(dat.annual2$Permit=="S05B")] = "State-troll"

g3 = ggplot(dat.annual2, aes(year, log10(meanrev), color = Permit)) + geom_line() + ylab("Log10 revenue per person") + xlab("Year") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

g4 = ggplot(dat.annual2, aes(year, meandiv, color = Permit)) + geom_line() + ylab("Species diversity") + xlab("Year") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

gridExtra::grid.arrange(g1,g2,g3, g4, ncol=2)

```
  
\break  
  
```{r fig2, echo=FALSE, fig.pos="placeHere", fig.cap="CV and mean annual revenue by salmon permit, 1975-2016. Average participation (unique fishers) given by circle size, and effective species diversity is shown with color shading. [EW notes: pretty cool clustering by permits here - highlighted by Ole. The modeling in the rest of the paper is largely comparing the blue seine fisheries to the orange gillnets in PWS / SEAK]", warning=FALSE, message=FALSE}
dat.annual = readRDS(file="../../portfolio/data-generated/salmon-annual-for-modeling.rds")

#cfec_all = readRDS("../../portfolio/data-generated/salmon_data_for_paper.rds")
people = group_by(cfec_all, p_fshy, year) %>% 
  summarize(n = length(unique(p_holder))) %>% 
  group_by(p_fshy) %>% summarize(n = mean(n,na.rm=T))
names(people)[which(names(people)=="p_fshy")] = "strategy_permit"
people$strategy_permit = paste0(substr(people$strategy_permit,1,1), substr(people$strategy_permit,3,5))

records_s03h = which((dat.annual$strategy_permit == "S03H" & dat.annual$year %in% c(1989,1990) | dat.annual$strategy_permit == "S04X"))

dat.annual = filter(dat.annual[-records_s03h,], npermit==1 & substr(strategy_permit,1,1)=="S") %>%
  group_by(strategy_permit) %>% 
  mutate(nPeople = length(unique(p_holder))) %>% 
  filter(nPeople > 200) %>% 
  dplyr::select(-nPeople) %>% 
  group_by(strategy_permit, year) %>% 
  summarize(meanrev = mean(revenue), meandiv = mean(specDiv)) %>% 
  arrange(strategy_permit, year) %>% 
  group_by(strategy_permit) %>% 
  summarize(mean_rev = mean(meanrev,na.rm=T), cv_rev = sd(diff(log(meanrev)),na.rm=T),
    diversity = mean(meandiv,na.rm=T)) %>% as.data.frame
  
dat.annual = left_join(dat.annual, people)
dat.annual$gear = substr(dat.annual$strategy_permit,2,3)
dat.annual$gear[which(dat.annual$gear=="01")]="Purse seine"
dat.annual$gear[which(dat.annual$gear=="03")]="Drift gillnet"
dat.annual$gear[which(dat.annual$gear=="04")]="Set gillnet"
dat.annual$gear[which(dat.annual$gear%in%c("05"))]="Hand troll"
dat.annual$gear[which(dat.annual$gear=="15")]="Power troll"

dat.annual$price = NA
dat.annual$price[dat.annual$strategy_permit=="S01A"]=250000
dat.annual$price[dat.annual$strategy_permit=="S01E"]=186700
dat.annual$price[dat.annual$strategy_permit=="S01H"]=84800
dat.annual$price[dat.annual$strategy_permit=="S01K"]=40000
dat.annual$price[dat.annual$strategy_permit=="S01L"]=227500
dat.annual$price[dat.annual$strategy_permit=="S01M"]=56900

dat.annual$price[dat.annual$strategy_permit=="S03A"]=88900
dat.annual$price[dat.annual$strategy_permit=="S03E"]=224200
dat.annual$price[dat.annual$strategy_permit=="S03H"]=63500
dat.annual$price[dat.annual$strategy_permit=="S03M"]=119500
dat.annual$price[dat.annual$strategy_permit=="S03T"]=148200
dat.annual$price[dat.annual$strategy_permit=="S03W"]=NA

dat.annual$price[dat.annual$strategy_permit=="S04D"]=88900
dat.annual$price[dat.annual$strategy_permit=="S04H"]=15300
dat.annual$price[dat.annual$strategy_permit=="S04K"]=77000
dat.annual$price[dat.annual$strategy_permit=="S04M"]=55900
dat.annual$price[dat.annual$strategy_permit=="S04T"]=38500
dat.annual$price[dat.annual$strategy_permit=="S04W"]=7300
dat.annual$price[dat.annual$strategy_permit=="S04X"]=5400
dat.annual$price[dat.annual$strategy_permit=="S04Y"]=9900
dat.annual$price[dat.annual$strategy_permit=="S04Z"]=11100

dat.annual$price[dat.annual$strategy_permit=="S05B"]=11000
dat.annual$price[dat.annual$strategy_permit=="S15B"]=38300

g1 = ggplot(dat.annual, aes(x=mean_rev, y=cv_rev, label = dat.annual$strategy_permit)) + geom_point(alpha=0.7, aes(col=gear,size=diversity)) + scale_size(range = c(0, 20)) + geom_text_repel() + ylab("CV annual revenue") + xlab("Mean revenue (dollars)") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
print(g1)
#pdf("Figure_01.pdf")
#print(g1)
#dev.off()
```

  
\break  
  
```{r fig3, echo=FALSE, fig.pos="placeHere", fig.cap="Harvest of hatchery produced salmon through time, species, and area. Shown are the numbers of hatchery fish caught by fisheries (top row), and the hatchery contribution each species to total catch (bottom row). The Alaska Peninsula is not included, because hatchery production has been approximately zero."}

seak_hatch = read.csv("../../salmon/data-generated/seak_hatcheryHarvest.csv")
pws_hatch = read.csv("../../salmon/data-generated/pws_hatcheryHarvest.csv")
kodiak_hatch = read.csv("../../salmon/data-generated/kodiak_hatcheryHarvest.csv")

seak_hatch = melt(seak_hatch, id.vars = c("Year"))
pws_hatch = melt(pws_hatch, id.vars = c("Year"))
kodiak_hatch = melt(kodiak_hatch, id.vars = c("Year"))

seak_hatch$region = "Southeast"
pws_hatch$region = "Prince William Sound"
kodiak_hatch$region = "Kodiak - Alaska Peninsula"

seak_hatch$value[is.na(seak_hatch$value)] = 0
pws_hatch$value[is.na(pws_hatch$value)] = 0
kodiak_hatch$value[is.na(kodiak_hatch$value)] = 0

dat = bind_rows(seak_hatch, pws_hatch)
dat = bind_rows(dat, kodiak_hatch)

names(dat)[which(names(dat)=="variable")]="species"
dat$value = dat$value / 1000000

# chinook chum coho pink sock
cbPalette <- c("#009E73", "#4B2E83", "#999999", "#CC79A7", "#D55E00")

dat$col = as.numeric(as.factor(dat$species))
g1 = ggplot(dat, aes(Year, value)) +
  geom_area(aes(fill = species), position = "stack") +
  xlab("Year") + ylab("Hatchery harvest (millions)") +
  scale_fill_manual(values = c('Chinook'=cbPalette[1], 'Chum'=cbPalette[2], 
    'Coho'=cbPalette[3], 'Pink'=cbPalette[4], 'Sockeye'=cbPalette[5]), name="Species",
    labels =c("Chinook","Sockeye","Coho","Pink","Chum")) + 
  facet_wrap(~region, scale="free_y") + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

# bring in total harvest data (hatchery + wild)
hatch = read.csv("../../salmon/data-generated/commonPropertyCommercialCatch.csv",
  stringsAsFactors = FALSE)

kodap1 = hatch[which(hatch$Region%in%c("Kodiak") & hatch$Year <= 1995),]
kodap2 = hatch[which(hatch$Region%in%c("AP", "Kodiak") & hatch$Year > 1995),]
kodap2 = dplyr::group_by(kodap2, Year) %>% 
  summarize(Chinook_harvest = sum(Chinook_harvest),
    Sockeye_harvest = sum(Sockeye_harvest),
    Coho_harvest = sum(Coho_harvest),
    Pink_harvest = sum(Pink_harvest),
    Chum_harvest = sum(Chum_harvest),
    Region = Region[1],
    Source = Source[1],
    ReportNumber = ReportNumber[1],
    Chinook_enhanced = sum(Chinook_enhanced),
    Sockeye_enhanced = sum(Sockeye_enhanced),
    Coho_enhanced = sum(Coho_enhanced),
    Pink_enhanced = sum(Pink_enhanced),
    Chum_enhanced = sum(Chum_enhanced))
kodap = rbind(as.data.frame(kodap1), as.data.frame(kodap2))
kodap$Region = as.character(kodap$Region)
kodap$Source = as.character(kodap$Source)
kodap$ReportNumber = as.character(kodap$ReportNumber)

hatch = rbind(hatch[which(hatch$Region %in% c("PWS","Southeast")),], kodap)




hatch$pChinook = hatch$Chinook_enhanced/hatch$Chinook_harvest
hatch$pSockeye = hatch$Sockeye_enhanced/hatch$Sockeye_harvest
hatch$pCoho = hatch$Coho_enhanced/hatch$Coho_harvest
hatch$pPink = hatch$Pink_enhanced/hatch$Pink_harvest
hatch$pChum = hatch$Chum_enhanced/hatch$Chum_harvest

hatch = hatch[,c("Year","pChinook","pSockeye","pCoho","pPink","pChum","Region")]
hatch = dplyr::rename(hatch, Chinook=pChinook,Sockeye=pSockeye, Coho=pCoho, Pink=pPink, Chum=pChum)
hatch$Region = as.character(hatch$Region)
hatch$Region[which(hatch$Region=="PWS")] = "Prince William Sound"
hatch$Region[which(hatch$Region=="Kodiak")] = "Kodiak - Alaska Peninsula"
hatch = melt(hatch, id.vars = c("Year","Region"))
names(hatch)[which(names(hatch)=="variable")]="Species"

g2 = ggplot(hatch, aes(Year, value, color=Species)) + 
  geom_line() + facet_wrap(~Region) + 
  xlab("Year") + ylab("Hatchery fraction of total catch") + 
  scale_color_manual(values = c('Chinook'=cbPalette[1], 'Chum'=cbPalette[2], 
    'Coho'=cbPalette[3], 'Pink'=cbPalette[4], 'Sockeye'=cbPalette[5]), name="Species",
    labels =c("Chinook","Sockeye","Coho","Pink","Chum")) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

gridExtra::grid.arrange(g1, g2)

# join datasets together for modeling
names(dat) = tolower(names(dat))
names(hatch) = tolower(names(hatch))
names(dat)[which(names(dat)=="value")] = "hatchery_harvest_millions"
names(hatch)[which(names(hatch)=="value")] = "percent_hatchery"
dat = left_join(dat, hatch)
dat$total_harvest = dat$hatchery_harvest_millions / (dat$percent_hatchery/100)
saveRDS(dat, file="../../salmon/data-generated/hatchery_harvest_millions.rds")
```
  
\break  
  
```{r fig4, echo=FALSE, fig.pos="placeHere", fig.cap="Effects of the fraction of hatchery fish on the year-to-year variability in landed weight at three scales: (1) Combining fisheries across regions, (2) Across fisheries, and (3) Average variability of individual fishers within fisheries. Effects of variability are presented in terms of effect sizes, or the natural log of the standard deviation of year-to-year catches in a scenario with hatchery fish constituting 10% of the catch to the standard deviation in a scenario with no hatchery fish in the catch. Dots represent mean estimates, and error bars represent +/- 1 standard error"}

df = readRDS(file=paste0("../../salmon/data-generated/","region","_df.rds"))
cbPalette <- c("#009E73", "#4B2E83", "#999999", "#CC79A7", "#D55E00")

df$fishery[which(df$fishery=="Prince William Sound")] = "PWS"
df$fishery[which(df$fishery=="Southeast")] = "SEAK"
df$fishery[which(df$fishery=="Kodiak")] = "Kodiak"


df$fishery[which(df$fishery=="Prince William Sound")] = "PWS"
df$fishery[which(df$fishery=="Southeast")] = "SEAK"
df$fishery[which(df$fishery=="Kodiak")] = "Kodiak"

p1 = ggplot(df, aes(x=fishery, y=bestimate, group=species, color=species)) +
  geom_point(position=position_dodge(0.5), alpha = 0.5, size=3) +
  ylab("Effect size (mean)") +
  xlab("") +
  geom_errorbar(aes(ymin=bestimate-bsd, ymax=bestimate+bsd),
    position=position_dodge(0.5), alpha=0.5) +
  scale_color_manual(values = c('Chinook'=cbPalette[1], 'Chum'=cbPalette[2],
    'Coho'=cbPalette[3], 'Pink'=cbPalette[4], 'Sockeye'=cbPalette[5]), name="Species",
    labels =c("Chinook","Sockeye","Coho","Pink","Chum"))+
  geom_hline(aes(yintercept=0), linetype = 2) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

p2 = ggplot(df, aes(x=fishery, y=estimate, group=species, color=species)) +
  geom_point(position=position_dodge(0.5), alpha = 0.5, size=3) +
  ylab("Effect size (sd)") +
  xlab("") +
  geom_errorbar(aes(ymin=estimate-sd, ymax=estimate+sd),
    position=position_dodge(0.5), alpha=0.5) +
  scale_color_manual(values = c('Chinook'=cbPalette[1], 'Chum'=cbPalette[2],
    'Coho'=cbPalette[3], 'Pink'=cbPalette[4], 'Sockeye'=cbPalette[5]), name="Species",
    labels =c("Chinook","Sockeye","Coho","Pink","Chum"))+
  geom_hline(aes(yintercept=0), linetype = 2) +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

gridExtra::grid.arrange(p1, p2, ncol=1)
```

\break  
  
  
```{r fig5, fig.pos="placeHere", fig.cap="Time varying effects of increasing the effective diversity of catch from 1 to 2 species (measured in ln dollars). Effective species diversity is calculated as 1/Simpson's Diversity. This shows declining benefits of diversification for most fisheries.", echo=FALSE}
# make yearpermit df
diffdat = readRDS(file="../../salmon/data-generated/salmon.rds")
years = seq(min(diffdat$year), max(diffdat$year))
permits = levels(as.factor(diffdat$permit))
# note that we have to use factor() here instead of unique() because
# that's the same as the ordering in the estimation code
yearpermit = data.frame("yrpermit"=levels(as.factor(diffdat$year_permit)))
yearpermit$year = as.numeric(substr(yearpermit$yrpermit,1,4))
yearpermit$permit = substr(yearpermit$yrpermit,6,9)

# grab original data to look at permit names
diffdat = readRDS(file="../../portfolio/data-generated/salmon-diff-for-modeling.rds")
years = seq(min(diffdat$year), max(diffdat$year)) 
#permits = levels(as.factor(diffdat$permit))

yearpermitold=yearpermit
load("../../salmon/analysis/model-linear.Rdata")
yearpermit=yearpermitold

est = extract(mod, permute="TRUE")

# start with making time series of estimates on mean
# challenge is that they're time varying quadratic functions
# do facet_wrap of estimates by year

# effect of adding more 1 species from 1. specdiv.prev = 1

specdiv.prev = seq(1, 5, by=0.1)
specdiv = specdiv.prev + 1 # always add 1 more in these comparisons
x1 = log(specdiv/specdiv.prev)
x2 = log(specdiv/specdiv.prev) * specdiv.prev
x3 = log(specdiv/specdiv.prev) * specdiv.prev^2

df = expand.grid("year"=1:length(years), "diversity" = seq(1,length(x1)), "permit"=1:6)
df$permits = permits[df$permit]
df$years = years[df$year]
df$x = specdiv.prev[df$diversity]
df$pred = 0
df$low = 0
df$high = 0
b0_indx = match(paste(as.character(df$years), as.character(df$permits)), as.character(yearpermit$yrpermit)) 
for(i in 1:nrow(df)) {
  #tmp = est$b0_str_yr[,b0_indx[i]] + 
  tmp = 
    x1[df$diversity[i]] * (est$b_1[,df$year[i], df$permit[i]])# +
    #x2[df$diversity[i]] * (est$b_2[,df$year[i], df$permit[i]]+est$b2_str_yr_mu)# +
    #x3[df$diversity[i]] * (est$b_3[,df$year[i], df$permit[i]]+est$b3_str_yr_mu)
  df$pred[i] = mean(tmp)
  df$low[i] = quantile(tmp,0.025)
  df$high[i] = quantile(tmp,0.975)
}

df$permits[which(df$permits=="S01A")] = "SEAK-seine"
df$permits[which(df$permits=="S01E")] = "PWS-seine"
df$permits[which(df$permits=="S01K")] = "Kodiak-seine"
df$permits[which(df$permits=="S01M")] = "AKP-seine"
df$permits[which(df$permits=="S03A")] = "SEAK-gillnet"
df$permits[which(df$permits=="S03E")] = "PWS-gillnet"

ggplot(df[df$diversity==1,], aes(x=years,y=pred,group=permits)) +
  geom_ribbon(aes(ymin=low,ymax=high), fill="blue",alpha=0.4) +
  geom_line(col="blue") + 
  facet_wrap(~permits) + xlab("Year") + ylab("Benefit of catch diversity increasing 1 to 2") + geom_hline(yintercept=0, color="red", linetype = 2) + theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

```

\break 
\break  
  
# References

