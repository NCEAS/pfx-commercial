---
title: 'Reduced diversity and increased specialization of Alaska salmon fishermen:
  effects on variation in individual revenues'
author: "Eric, Sean, Ole, Rich, Milo, Jordan, Jen, others"
date: ''
output:
  pdf_document:
    fig_caption: yes
  html_document: default
  word_document: default
bibliography: refs.bib
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE)
library(dplyr)
library(knitr)
library(ggplot2)
library(date)
library(ggtern)
library(reshape2)
library(mgcv)
library(fpc)
library(gridExtra)
library(glmmTMB)
library(zoo)
modelname = "model-linear" # model-linear-nointeractions
```

## Abstract
\setlength\parindent{24pt}

On a large scale, individual fishers may experience positive outcomes from diversifying their catches; examples include reduced year-to-year variability in annual revenue, and increases in average revenue. Fishers can increase their species diversity by owning a permit that allows multiple species to be targeted, or by owning multiple permits. External forces such as management regulations (limited entry,  catch shares) or market forces (permit prices) may disincentive individuals to hold multiple permits. Thus, individuals with a single permit may increase species diversity within the confines of their permit (longer fishing seasons, broader spatial area). Using a long-term dataset of individual salmon fishers in the Alaska, we develop new models for understanding how the effects of diversification have changed through time. These changes allow us to compare patterns across regions and gear, as well as better understand how external forces have changed incentives for diversifying (hatchery production and price trends, EVOS?). 

## Introduction

[broader paragraph on diversification with extensions to terrestrial agriculture etc, ]

Previous analyses have largely focused on patterns of diversification across ecosystems and the benefits to adopt more or less diverse fishing strategies [@kasperski_income_2013; @anderson_benefits]. Fisheries in Alaska have been studied extensively, because they are one of the most productive regions in North America (both by landed weight, and revenue [@office_of_science_and_technology_fisheries_2016]) and they allow individuals to adopt a wide range of fishing strategies. [@anderson_benefits] defined strategies as a permit or collection of permits held by single individuals. While adding new permits allows fishers to increase species diversity, few individual permits allow individuals to harvest more than one species (examples of single-species permits in the Gulf of Alaska include halibut, sablefish, herring, crab, shellfish, shrimp, sea cucumber). Some exceptions to these single species permits include participants in federally managed groundfish fisheries and participants in state managed salmon fisheries.  
  
Understanding the effects of species diversification on salmon fishers is particularly important, as the number of salmon specialists (defined as fishers holding a single salmon permit) has increased over the last 30 years as a fraction of the total [@anderson_benefits]. For these limited entry salmon fisheries, general trends that have emerged are that more people are participating since the early 2000s (Fig. A1), median revenue is increasing (across individuals, Fig. A2), and landed species diversity declining over time (averaged across indivduals, Fig. A6). Across different salmon fisheries, other than a slight negative effect of diversification on variability (similar to [@anderson_benefits]), there appears to be little correlation between diversity and revenue (Fig. A4). In terrestrial agriculture, there are numerous examples where diversification may affect the mean or CV but not both [@purdy_financial_1997], and the same result may be true for salmon fishers. Further, these impacts of diversification may be variable over time.    
  
Five species of salmon are encountered in Alaska waters (Chinook [*Oncorhynchus tshawytscha*], chum [*O. keta*], pink [*O. gorbuscha*], sockeye [*O. nerka*], coho [*O. kisutch*]), and the ability of individual salmon fishers to diversify across species is in part a function of geography and gears. For example, salmon may be caught with purse seine gear (n = 6 areas), drift gillnets (5 areas), and set gillnets (12 areas). Other gears include beach seine and troll gears (though these are generally restricted to Kodiak and Southeast Alaska, respectively). While some of these combinations of gears and areas allow fishers to diversify, there are many examples of permits where the catch is dominated by a single species. Perhaps the best examples include fisheries that target sockeye salmon (e.g. Bristol Bay set and drift gillnet fisheries). For these fisheries, specialization is associated with higher revenue and reduced CV in annual revenue [@anderson_benefits].

A secondary motivation for focusing on the effects of diversification for salmon fishers is to better understand the long term consequences of hatchery salmon production on the revenue and variability in revenue of individuals. Following low returns and declining productivity in the mid 1980s, many hatchery programs in the state rapidly increased hatchery releases [@mahnken_historical_1998; @leber_stock_2008]. Many of these hatchery programs increased production to stabilize the variability of fishers catch (and revenue), though these programs may also have costs to wild production [@ruggerone_productivity_2015]. The intra- and inter-specific effects of large scale hatchery programs has been debated [@hilborn_review_2001; @hilborn_hatcheries_1992; @wertheimer_comment:_2001; @heard_hatchery], but the effects of hatcheries have largely been focused on ecological interactions of aggregate yield to the fishery [@leber_stock_2008] or economic impacts [boyce_alaska_1993], rather than to variability experienced by individual fishermen. [Other history here?]

[Jordan: Maybe a paragraph or notes about the importance of the role that salmon are serving in buffering or stabilizing fishing revenues in the state and how subsequently, understanding the responses of salmon to climate dynamics is especially critical (Mueter et al. 2002, and maybe Schindler et al., 2010)]

In addition to the changing species composition of fish avaialble to be harvested, the benefits (or costs) of diversification are likely affected by a number of exogenous drivers, including marketing, prices, new processing technology [@knapp_trends]. [Break out as own paragraph+add more examples?] Following price crashes in the early 2000s, many of these factors have been positive for salmon fishermen (increasing trends in prices and catches, Fig. A3, A12). In contrast, the late 1980s - early 1990s experienced high abundance and low prices (in part due to collapses of foreign currencies). Combined with the increased trend in hatchery production and resulting changes in species compositon of adult salmon, these external factors may have also altered incentives for diversification. If there's an incentive to substitute high value species (Chinook, sockeye) with more abundant low value species (pink, chum), the analog in the terrestrial framring world would be crop substitution of low-volume high value crops (spices) with high-volume low value crops (cereals) (other examples in literature = cocoa, tobacco).  

The objective of our analysis is to better understand the effects of diversification on single-permit salmon holders by extending the methods used by [@anderson_benefits] to include time-varying effects. These time-varying effects will allow us to compare temporal trends across regions, identify periods when having diverse catch portfolio was most beneficial, and allow us to evaluate support for effects of longer term drivers in the region. 

## Methods

### Data  

We obtained fisheries landings and revenue data for all permit holders in Alaska from 1985 - 2014 from the Commercial Fisheries Entry Commission (CFEC). We adjusted for inflation by setting all revenues in 2009 USD. Because were were only interested in single permit fisheries, we adopted a simplified version of the filtering steps described in [@anderson_benefits]. After aggregating individual fish tickets to annual data, we retained individuals who only fished one of the six salmon permits included in a year (Table 1, Fig. A5). Like [@anderson_benefits] we also worked with a log-differenced dataset to remove non-stationary individuals; to avoid complications of individuals switching strategies, we only included pairs of years for a given person where they did not change strategies. 

```{r, echo=FALSE}
m = matrix("", 6, 3)
m[1,] = c("S01A", "Purse Seine", "Southeast Alaska")
m[2,] = c("S01E", "Purse Seine", "Prince William Sound")
m[3,] = c("S01K", "Purse Seine", "Kodiak")
m[4,] = c("S01M", "Purse Seine", "Alaska Peninsula")
m[5,] = c("S03A", "Gillnet", "Southeast Alaska")
m[6,] = c("S03E", "Gillnet", "Prince William Sound")
colnames(m) = c("Permit", "Gear", "Region")
kable(m)
```

### As hatchery programs have increased production, have individual salmon fishermen experienced reduced variability?  

Hatchery release trends for some regions included in our data have been summarized previously (e.g. [@ward_evaluating] summarized the trends for Prince William Sound). Release patterns have been dominated by pink and chum salmon (for PWS, these species represent 80% and 18% of total releases for 2012-2014 respectively, [@ward_evaluating]) and production has increased since the late 1970s (217 million juvenile pink salmon in PWS in 1985 versus 672 million in 2014). Though our analysis with CFEC data doesn't separate hatchery versus wild fish, as a contrast we can make coarse comparisons across regions and species to examine potential effects of hatchery fish on variability. For example, we can compare the variation in pink salmon returns (earnings or weight) from Prince William Sound (largely hatchery) to those from Southeast Alaska (largely wild). Similarly, we can compare the variability in earnings from species dominated by hatchery returns (pink, chum) to those with less hatchery influence (Chinook, sockeye). To make these comparisons, we aggregated the earnings and landings by species and permit, then calculated 3-year rolling CVs. As a second comparison, we examined whether long-term participants in any of the fisheries had experienced a change in variability. Similar to [@kasperski_income_2013] who calculated CVs of vessels before and after significant managment events, we identified individuals who fished the same permit for at least three years in the first decade of our data (1985-1995) and at least three years in the last decade of the data (2004-2014). 

### Robustness of strategies to changing environments [stash in appendix?]

One of the challenges in modeling the effects of species diversification for individual fishers is that between two years, both the species composition of the catch and the species composition of the fish available to be caught may change (making it hard to disentangle the selectivity of fishermen versus portfolio of fish available). To isolate the effects of a changing environment from changing strategies, we used a subset of the data from fishery permits where discrete strategies were emergent. For details see Appendix. 

Using purse seine permit holders in Prince William Sound as an example, we first calculated the species composition (weighted by revenue) for each active permit holder in each year. For each pair of years that an individual fished, we calculated the squared Euclidian distance between the species compositions of those years, $$\Delta { p }_{ ind,t }=\sum _{ sp=1 }^{ 5 }{ { \left| { p }_{ ind,sp,t }-{ p }_{ ind,sp,t-1 } \right|  }^{ 2 } } $$.  

Larger values of $\Delta { p }_{ ind,t }$ indicate greater year-to-year discrepancy in species composition. To focus on individuals who had more constant strategies in adjacent years, we ommitted data corresponding to the upper third of this distribution (retaining $\Delta { p }_{ ind,t }$ < 0.334). Next, we used the species composition from each individual and pair of years to cluster individuals into strategies. Clustering was performed using the partitioning around medoids (pam) algorithm in R with an estimated number of clusters (using 'pamk' in fpc library), and selected 2 groups of individual strategies: pink salmon specialization (medoid proportion of pink salmon = 0.95), and a strategy focused on pink salmon and chum (medoid proportions of 0.64 and 0.31 respectively). For each group, we then calculated the mean and CV of revenue; we calculated the log difference of revenue for each individual, $\Delta { R }_{ i }=log\left( { R }_{ i,t+1 }/{ R }_{ i,t } \right)$ and then calculated the CV as the standard deviation over people, $sd(\Delta { R }_{ i=1:n })$.  

### Analysis 3: [Core of paper] Does effect of diversification change over time?

[@anderson_benefits] implemented a hierarchical Bayesian model that allowed group level predictors and covariates (diversity of catch, days fished) to simultaneously affect the mean and the variance of revenue for individual fishers. This model also included random intercepts by strategy and year; these terms allowed all permit holders in a given year to experience common fluctuations (external drivers including price changes, fluctuations in fish population abundance, or environmental disasters such as EVOS). 

To ask how benefits of diversification may have changed over time, we extend the model of [@anderson_benefits] to also include time-varying random effects in the slope coefficients of diversification. We define the variables $\Delta { S }_{ t }=log\left( { S }_{ t }/{ S }_{ t-1 } \right)$ to represent the percent change in species diversity of the catch between years and $\Delta { D }_{ t }=log\left( { D }_{ t }/{ D }_{ t-1 } \right)$ to represent the percent change in fishing effort (days fished) between years. The model for the expected log revenue of individual *i* in year *t*, $$\widehat { log\left( { R }_{ i,t } \right)  } ={ B }_{ 0,j,t }+{ B }_{ 1,j,t }\cdot \Delta S_{ i,t }+{ B }_{ 2,j,t }\cdot \left( \Delta S_{ i,t }\cdot { S }_{ i,t-1 } \right) +{ B }_{ 3,j }\cdot \Delta D_{ i,t }+log\left( { R }_{ i,t-1 } \right) $$, where *j* subscripts the salmon permit (Table 1). We model the time-varying permit specific intercepts as random and exchangeable across years, ${ B }_{ 0,j,t }\sim Normal\left( { u }_{ { B }_{ 0 } },{ \sigma  }_{ { B }_{ 0 } } \right)$. The term ${ B }_{ 1,j,t }$ represents the permit level random effect of diversifying species. Our model extends that of [@anderson_benefits] to include the interaction terms $\Delta S_{ t }\cdot { S }_{ t-1 }$ which allow the effect of diversification to be dependent on the previous level of diversification. We assume this relationship is linear, and the coefficients ${ B }_{ 1,j,t }$ and ${ B }_{ 2,j,t }$ allow this to vary by permit and through time. The flexibility in these terms allows the benefit of increasing species diversity to be positive in some years (generalizing benefits revenue), negative in other years (specializing benefits revenue) and neutral in other years (revenue is independent of alterations to catch composition). We constrain the random effects associated with diversification to be modeled as autoregressive processes with shared variances across strategies, for example: ${ B }_{ 1,j,t }\sim Normal\left( { B }_{ 1,j,t-1 },{ \sigma  }_{ { B }_{ 1 } } \right)$. Like [@anderson_benefits] we also allow changing effort (measured as percent change in days fished) ${ B }_{ 4,j }$ to vary by strategy, but we do not allow this effect to vary through time. Finally, the term $log\left( { R }_{ i,t-1 } \right)$ is included as an offset [@anderson_benefits]. 
  Like [@anderson_benefits], we also included all of the above covariates in the variance model. We assumed the residuals from the mean model described above to be normally distributed, $$log\left( { R }_{ i,t } \right) \sim Normal\left( \widehat { log\left( { R }_{ i,t } \right)  } ,\widehat { { \sigma  }_{ i,t } }  \right) $$. While conventional hierarchcial linear regression assumes variances to be constant or shared by grouping variables, we also included fixed and random covariates, making the model akin to variance function regression or stochastic volatility models (CITE). Using the same notation as for the mean, we can express the log standard deviation as $$\widehat { log\left( { \sigma  }_{ i,t } \right)  } ={ G }_{ 0,j }+{ G }_{ 1,j,t }\cdot \Delta S_{ i,t }+{ G }_{ 2,j,t }\cdot \left( \Delta S_{ i,t }\cdot { S }_{ i,t-1 } \right) +G_{ 3,j }\cdot \Delta D_{ i,t }$$. Unlike the linear model for the mean, we did not include an offset term. Further, we constrained the variance intercepts ${ G }_{ 0,j }$ to be temporally constant by strategy, instead of the dynamic nature of the intercepts in the mean model. Like the mean model, the random effects were constrained to be autoregressive, ${ G }_{ 1,j,t }\sim Normal\left( { G }_{ 1,j,t-1 },{ \sigma  }_{ { G }_{ 1 } } \right)$, and covariates associated with days fished and species diversity were included as predictors. 

All done in STAN [@stan_development_team_stan_2015] using the NUTS algorithm [@hoffman_no-u-turn_2014].

Specific things that could be looked at: 
- EVOS (closure for Kodiak)  
- PWS pink salmon crash in 1992/1993: Pacific Salmon & their Ecosystems: Status and Future Options
- sockeye marketing 1983: [Jordan: So the Copper River salmon marketing ramped up in about 1983. I wonder if we could see a steady increase in value or movement towards sockeye in the early years of the data set] 

Does diversification exist within permits and if so, do we see similar advantages of diversification on revenue + CV?  
  
## Results

Our summaries of changing variability (aggregate for each fishery, across individuals, or within individuals) was not consistent with the hypothesis that variability in revenue or landings has decreased over time (Fig. A9-A10). For pink and chum salmon, fisheries in PWS generally experience higher year to year variability compared to SEAK. In looking at the changing CV of individuals, we see a slight increase in the CV of revenue for people fishing in the recent decade who were also fishing 1985-1995 (with the exception being S01A). 

Figure 1 and 2 shows the time series of species composition and effective spp diversity. Interesting patterns are (1) overall low diversity of S01E (pinks), (2) increasing chum in S03A

Figure 3: One component of variability is the year-to-year variation that individuals experience as a result of external forces (stock abundance, prices, etc). Or common fluctuations in revenue experienced by all permit holders [@anderson_benefits]. This shows the time varying intercepts on the mean -- negative equals losing revenue on average, positive = increasing revenue. This shows big differences between permit types (gillnets tend to have lower year-to-year variation). Some permits have extreme variation - S01E (PWS seine) has fluctuations between exp(-1) and exp(+1), corresponding to year-to-year changes of 36-270%.  
  
Figure 4 shows the time varying nature of of the model for all permits. These are the time series of benefits of changing from effective species diversity of 1 to 2, and here we're basically isolating year-to-year differences in revenue (the intercepts) from diversification benefits. In some cases the effect is positive (fishing more spp = more revenue). But in many cases it's not, and the trend is negative (indicating that specialization is more profitable over time). In some cases, these time series mirror the aggregate diversity in the raw time series (Fig. 1). I think we also expect this result - fishermen increase diversity or not, because it's profitable. 
  
Figure 5 shows that temporal trends, by permit, in going from 1 to 2 species fished on the variance (again removing the overall intercepts). From [@anderson_benefits] we'd expect diversification to redudce variance. A few examples of how to read this: S01A is slightly positve for most of the time series, but rapidly increases in the last 10 years -- this means generalists with diverse portfolios have had increases in year-to-year variability. For S01E, the start and end of the time series are associated with these 'costs' to diversification. For S03E, we see a more gradual trend (cost of diversification increases).

## Discussion

- Revenue is going up since 2000 -- but each permit holder is fishing more (more days, more total pounds) and the trend in weight is faster than the trend in price. 

- Ability to specialize primarily driven by many forces beyond control of fishermen. But in some situations, diversification is possible by extending fishing season to exploit additional spp (fishing earlier for chum in PWS S01E). Or fishing different areas to exploit more spp in S03 (SEAK). 

- Prices are generally synchronous for all spp (especially coho/chum/pink), and have increased at a faster rate compared to chum and pink salmons since 2000 (Fig A8-A9). We're also seeing a trend toward greater synchrony between species (Fig A11-A12, A14). Projecting future prices are complex [@knapp_trends]. Synchrony in prices may largely be function of marketing, improved product, freezing, etc. 

- We're seeing increased specialization within permits. People in PWS are trending toward increased specialization on pink salmon. People in SEAK trending toward increased specialization on chum. Both of these are switches from higher value species (sockeye, chum) to lower value species. Both pink and chum have higher variability in year to year returns than sockeye. 

- One pontential exogenous driver related to management that can be ruled out as being responsible for increased specialization of salmon fishermen is changes in the timing or length of fishing seasons. Shifting seasons to later in the year may reduce catch of early run fish for example. However, we found no significant trend in either the season length or average season date for any fishery (Fig. A15).

\break  

```{r, echo=FALSE, fig.pos="placeHere", fig.cap="Time varying species composition and diversity, by permit. Species are colored as follows: yellow (chum), pink (sockeye), red (Chinook), green (coho), blue (pink salmon).", fig.height=3.2}
cfec <- feather::read_feather("../../portfolio/data-generated/salmon.feather")
cfec$year = as.numeric(substr(cfec$landdate, 1, 4))

library(dplyr)
# plot proportion of species landed by salmon permit
g1 = group_by(cfec[cfec$p_fshy=="S 01A" & cfec$spec %in% c("CHUM","COHO","SOCK","PINK","CHNK"),], year, spec, p_fshy) %>%
  summarize(p = sum(g_earn)) %>% group_by(year, p_fshy) %>% mutate(p = p/sum(p)) %>%
  ggplot(aes(year, p, group=spec, color = spec)) + geom_line() +  
  ylab("Species %") + xlab("") + ggtitle("S01A") + theme(legend.position="none")

g2 = group_by(cfec[cfec$p_fshy=="S 01E" & cfec$spec %in% c("CHUM","COHO","SOCK","PINK","CHNK"),], year, spec, p_fshy) %>%
  summarize(p = sum(g_earn)) %>% group_by(year, p_fshy) %>% mutate(p = p/sum(p)) %>%
  ggplot(aes(year, p, group=spec, color = spec)) + geom_line() +  
  ylab("Species %") + xlab("") + ggtitle("S01E") + theme(legend.position="none")

g3 = group_by(cfec[cfec$p_fshy=="S 01K" & cfec$spec %in% c("CHUM","COHO","SOCK","PINK","CHNK"),], year, spec, p_fshy) %>%
  summarize(p = sum(g_earn)) %>% group_by(year, p_fshy) %>% mutate(p = p/sum(p)) %>%
  ggplot(aes(year, p, group=spec, color = spec)) + geom_line() +  
  ylab("Species %") + xlab("") + ggtitle("S01K") + theme(legend.position="none")

g4 = group_by(cfec[cfec$p_fshy=="S 01M" & cfec$spec %in% c("CHUM","COHO","SOCK","PINK","CHNK"),], year, spec, p_fshy) %>%
  summarize(p = sum(g_earn)) %>% group_by(year, p_fshy) %>% mutate(p = p/sum(p)) %>%
  ggplot(aes(year, p, group=spec, color = spec)) + geom_line() +  
  ylab("Species %") + xlab("") + ggtitle("S01M") + theme(legend.position="none")

g5 = group_by(cfec[cfec$p_fshy=="S 03A" & cfec$spec %in% c("CHUM","COHO","SOCK","PINK","CHNK"),], year, spec, p_fshy) %>%
  summarize(p = sum(g_earn)) %>% group_by(year, p_fshy) %>% mutate(p = p/sum(p)) %>%
  ggplot(aes(year, p, group=spec, color = spec)) + geom_line() +  
  ylab("Species %") + xlab("") + ggtitle("S03A") + theme(legend.position="none")

g6 = group_by(cfec[cfec$p_fshy=="S 03E" & cfec$spec %in% c("CHUM","COHO","SOCK","PINK","CHNK"),], year, spec, p_fshy) %>%
  summarize(p = sum(g_earn)) %>% group_by(year, p_fshy) %>% mutate(p = p/sum(p)) %>%
  ggplot(aes(year, p, group=spec, color = spec)) + geom_line() +  
  ylab("Species %") + xlab("") + ggtitle("S03E") + theme(legend.position="none")

dat.diff = readRDS(file="../../portfolio/data-generated/cfec-diff-for-modeling.rds")
dat.diff = dat.diff[which(dat.diff$revenue >= 10000 & dat.diff$revenue.prev >= 10000), ]
dat.salmon = dat.diff[dat.diff$strategy_permit%in%c("S01A", "S01E", "S01K", "S03A", "S03E","S01M"),]

h1 = group_by(dat.salmon[dat.salmon$strategy_permit=="S01A",], year, strategy_permit) %>%
  summarize(meanDiv = mean(specDiv), low = quantile(specDiv,0.25), upp = quantile(specDiv,0.75)) %>%
  ggplot(aes(year, meanDiv)) + geom_line() + 
  geom_ribbon(aes(ymin= (low), ymax= (upp)), alpha=0.4) + ylab("Diversity") + xlab("") + theme(legend.position="none")

h2 = group_by(dat.salmon[dat.salmon$strategy_permit=="S01E",], year, strategy_permit) %>%
  summarize(meanDiv = mean(specDiv), low = quantile(specDiv,0.25), upp = quantile(specDiv,0.75)) %>%
  ggplot(aes(year, meanDiv)) + geom_line() + 
  geom_ribbon(aes(ymin= (low), ymax= (upp)), alpha=0.4) + ylab("Diversity") + xlab("") + theme(legend.position="none")

h3 = group_by(dat.salmon[dat.salmon$strategy_permit=="S01K",], year, strategy_permit) %>%
  summarize(meanDiv = mean(specDiv), low = quantile(specDiv,0.25), upp = quantile(specDiv,0.75)) %>%
  ggplot(aes(year, meanDiv)) + geom_line() + 
  geom_ribbon(aes(ymin= (low), ymax= (upp)), alpha=0.4) + ylab("Diversity") + xlab("") + theme(legend.position="none")

h4 = group_by(dat.salmon[dat.salmon$strategy_permit=="S01M",], year, strategy_permit) %>%
  summarize(meanDiv = mean(specDiv), low = quantile(specDiv,0.25), upp = quantile(specDiv,0.75)) %>%
  ggplot(aes(year, meanDiv)) + geom_line() + 
  geom_ribbon(aes(ymin= (low), ymax= (upp)), alpha=0.4) + ylab("Diversity") + xlab("") + theme(legend.position="none")

h5 = group_by(dat.salmon[dat.salmon$strategy_permit=="S03A",], year, strategy_permit) %>%
  summarize(meanDiv = mean(specDiv), low = quantile(specDiv,0.25), upp = quantile(specDiv,0.75)) %>%
  ggplot(aes(year, meanDiv)) + geom_line() + 
  geom_ribbon(aes(ymin= (low), ymax= (upp)), alpha=0.4) + ylab("Diversity") + xlab("") + theme(legend.position="none")

h6 = group_by(dat.salmon[dat.salmon$strategy_permit=="S03E",], year, strategy_permit) %>%
  summarize(meanDiv = mean(specDiv), low = quantile(specDiv,0.25), upp = quantile(specDiv,0.75)) %>%
  ggplot(aes(year, meanDiv)) + geom_line() + 
  geom_ribbon(aes(ymin= (low), ymax= (upp)), alpha=0.4) + ylab("Diversity") + xlab("") + theme(legend.position="none")

gridExtra::grid.arrange(g1, g2, g3, h1, h2, h3, nrow=2)
```

```{r, echo=FALSE, fig.pos="placeHere", fig.cap="Time varying species composition and diversity, by permit.", fig.height=3.2} 
gridExtra::grid.arrange(g4, g5, g6, h4, h5, h6, nrow=2)
```
  
\break  
  
```{r, echo=FALSE}
library(rstan)
```

```{r, eval=FALSE,echo=FALSE}
load("../../salmon/analysis/cv-model-simple.Rdata")
# groups here are 80% pink vs 97% pink

yrs = 1986:2014

hist(extract(mod)[["g_offset"]], 40, col="grey", xlab="Effect of specializing on pink (sd)")

xx = exp(extract(mod)[["sd_yr"]])
df.gen = data.frame("year"=yrs, "mean" = apply(xx, 2, mean), "low" = apply(xx, 2, quantile, 0.025),
  "hi" = apply(xx, 2, quantile, 0.975), "strategy"="pink:chum")

offset = matrix(extract(mod)[["g_offset"]],ncol=1) %*% matrix(rep(1,length(yrs)), nrow=1)
xx = exp(extract(mod)[["sd_yr"]] + offset)
df.spec = data.frame("year"=yrs, "mean" = apply(xx, 2, mean), "low" = apply(xx, 2, quantile, 0.025),
  "hi" = apply(xx, 2, quantile, 0.975), "strategy"="pink")

ggplot(data=rbind(df.gen,df.spec), aes(year, mean, group=strategy, fill=strategy)) + geom_ribbon(aes(ymin=low,ymax=hi), alpha=0.5) + geom_hline(yintercept=0, color="red")

```


```{r, echo=FALSE, fig.pos="placeHere", fig.cap="Time varying intercepts on estimated mean revenue, by permit. These are interpreted as the mean change in revenue for each permit holder in each year (positive equates to increasing revenue, etc), after accounting for effects of catch diversification and days fished."}
# grab original data to look at permit names
diffdat = readRDS(file="../../salmon/data-generated/salmon.rds")
years = seq(min(diffdat$year), max(diffdat$year))
permits = levels(as.factor(diffdat$permit))

yearpermit = data.frame("yrpermit"=levels(diffdat$year_permit))
yearpermit$year = as.numeric(substr(yearpermit$yrpermit,1,4))
yearpermit$permit = substr(yearpermit$yrpermit,6,9)

load(paste0("../../salmon/analysis/",modelname,".Rdata"))

est = extract(mod, permute="TRUE")

yearpermit$b0 = apply(est$b0_str_yr,2,median)
yearpermit$b0_low = apply(est$b0_str_yr,2,quantile,0.025)
yearpermit$b0_hi = apply(est$b0_str_yr,2,quantile,0.975)

ggplot(data=yearpermit) + 
  geom_ribbon(aes(x=year,ymin=b0_low,ymax=b0_hi),alpha=0.3) +
  geom_line(aes(x=year,y=b0)) + 
  facet_wrap(~permit) + xlab("Year") + 
  ylab("Intercepts on mean") + 
  geom_hline(yintercept=0, color="red")
```
  
\break  
  
```{r, fig.pos="placeHere", fig.cap="Time varying effects of adding 1 species on revenue (measured in ln dollars) for purse seine permit in Prince William Sound (S01E). This figure illustrates two things: (1) the benefit of adding more species diminishes as a function of past diversity, and (2) the economic benefit to adding more species has been reduced through time.", echo=FALSE, eval=FALSE}
# grab original data to look at permit names
diffdat = readRDS(file="../../salmon/data-generated/salmon.rds")
years = seq(min(diffdat$year), max(diffdat$year))
permits = levels(as.factor(diffdat$permit))

load(paste0("../../salmon/analysis/",modelname,".Rdata"))

est = extract(mod, permute="TRUE")

# start with making time series of estimates on mean
# challenge is that they're time varying quadratic functions
# do facet_wrap of estimates by year

# effect of adding more 1 species from 1. specdiv.prev = 1

specdiv.prev = seq(1, 5, by=0.1)
specdiv = specdiv.prev + 1 # always add 1 more in these comparisons
x1 = log(specdiv/specdiv.prev)
x2 = log(specdiv/specdiv.prev) * specdiv.prev

df = expand.grid("year"=1:29, "diversity" = seq(1,length(x1)), "permit"=1:6)
df$permits = permits[df$permit]
df$years = years[df$year]
df$x = specdiv.prev[df$diversity]
df$pred = 0
df$low = 0
df$high = 0
b0_indx = match(paste(as.character(df$years), as.character(df$permits)), as.character(yearpermit$yrpermit)) 

for(i in 1:nrow(df)) {
  tmp = x1[df$diversity[i]] * (est$b_1[,df$year[i], df$permit[i]])# + x2[df$diversity[i]] * (est$b_2[,df$year[i], df$permit[i]]+est$b2_str_yr_mu)
  df$pred[i] = median(tmp)
  df$low[i] = quantile(tmp,0.025)
  df$high[i] = quantile(tmp,0.975)
}
df_s01e_b1 = df
ggplot(df[df$permits=="S01E",], aes(x=x,y=pred,group=years)) +
  #geom_ribbon(aes(ymin=low,ymax=high), alpha=0.4) +
  geom_line() +
  facet_wrap(~years) + xlab("Previous species diversity") + ylab("Predicted benefit of adding +1 spp (ln $)")

```
  
\break  

```{r, fig.pos="placeHere", fig.cap="Time varying effects of adding 1 species on revenue (measured in ln dollars) for hypothetical individuals with species diversity ~ 1. This shows declining benefits of diversification for most fisheries, S01M.", echo=FALSE}
# grab original data to look at permit names
diffdat = readRDS(file="../../salmon/data-generated/salmon.rds")
years = seq(min(diffdat$year), max(diffdat$year))
permits = levels(as.factor(diffdat$permit))

load(paste0("../../salmon/analysis/",modelname,".Rdata"))

est = extract(mod, permute="TRUE")

# start with making time series of estimates on mean
# challenge is that they're time varying quadratic functions
# do facet_wrap of estimates by year

# effect of adding more 1 species from 1. specdiv.prev = 1

specdiv.prev = seq(1, 5, by=0.1)
specdiv = specdiv.prev + 1 # always add 1 more in these comparisons
x1 = log(specdiv/specdiv.prev)
x2 = log(specdiv/specdiv.prev) * specdiv.prev
x3 = log(specdiv/specdiv.prev) * specdiv.prev^2

df = expand.grid("year"=1:29, "diversity" = seq(1,length(x1)), "permit"=1:6)
df$permits = permits[df$permit]
df$years = years[df$year]
df$x = specdiv.prev[df$diversity]
df$pred = 0
df$low = 0
df$high = 0
b0_indx = match(paste(as.character(df$years), as.character(df$permits)), as.character(yearpermit$yrpermit)) 

for(i in 1:nrow(df)) {
  #tmp = est$b0_str_yr[,b0_indx[i]] + 
  tmp = 
    x1[df$diversity[i]] * (est$b_1[,df$year[i], df$permit[i]])# +
    #x2[df$diversity[i]] * (est$b_2[,df$year[i], df$permit[i]]+est$b2_str_yr_mu)# +
    #x3[df$diversity[i]] * (est$b_3[,df$year[i], df$permit[i]]+est$b3_str_yr_mu)
  df$pred[i] = mean(tmp)
  df$low[i] = quantile(tmp,0.025)
  df$high[i] = quantile(tmp,0.975)
}

ggplot(df[df$diversity==1,], aes(x=years,y=pred,group=permits)) +
  geom_line() +
  geom_ribbon(aes(ymin=low,ymax=high), alpha=0.4) +
  facet_wrap(~permits) + xlab("Year") + ylab("Predicted benefit of adding +1 spp (ln $)") + geom_hline(yintercept=0, color="red")

```
  
\break  
  
```{r, fig.pos="placeHere", fig.cap="Time varying effects of adding 1 species on log standard deviation of revenue for hypothetical individuals with species diversity ~ 1.", echo=FALSE}
# grab original data to look at permit names
diffdat = readRDS(file="../../salmon/data-generated/salmon.rds")
years = seq(min(diffdat$year), max(diffdat$year))
permits = levels(as.factor(diffdat$permit))

load(paste0("../../salmon/analysis/",modelname,".Rdata"))

est = extract(mod, permute="TRUE")

# start with making time series of estimates on mean
# challenge is that they're time varying quadratic functions
# do facet_wrap of estimates by year

# effect of adding more 1 species from 1. specdiv.prev = 1

specdiv.prev = seq(1, 5, by=0.1)
specdiv = specdiv.prev + 1 # always add 1 more in these comparisons
x1 = log(specdiv/specdiv.prev)
x2 = log(specdiv/specdiv.prev) * specdiv.prev
x3 = log(specdiv/specdiv.prev) * specdiv.prev^2

df = expand.grid("year"=1:29, "diversity" = seq(1,length(x1)), "permit"=1:6)
df$permits = permits[df$permit]
df$years = years[df$year]
df$x = specdiv.prev[df$diversity]
df$pred = 0
df$low = 0
df$high = 0

for(i in 1:nrow(df)) {
  #tmp = est$g0 + est$g0_strategy[,df$permit[i]] + 
  tmp = 
    x1[df$diversity[i]] * (est$g_1[,df$year[i], df$permit[i]])# +
    #x2[df$diversity[i]] * (est$g_2[,df$year[i], df$permit[i]]+est$g2_str_yr_mu)
  df$pred[i] = median(tmp)
  df$low[i] = quantile(tmp,0.025)
  df$high[i] = quantile(tmp,0.975)
}

ggplot(df[df$diversity==1,], aes(x=years,y=pred,group=permits)) +
  geom_line() +
  geom_ribbon(aes(ymin=low,ymax=high), alpha=0.4) +
  facet_wrap(~permits) + xlab("Year") + ylab("Predicted marginal benefit of adding +1 spp (ln $)") + geom_hline(yintercept=0, color="red")

``` 
  
```{r, echo=FALSE, fig.pos="placeHere", fig.cap = "As model validation, we can compare the estimated intercepts for PWS S01E (purse seine) representing average year to year change in revenue versus the change year over year in ln(pink salmon returns). Correlation between them is ~ 0.8. This suggests (as expected) people on average make a lot more money in years when pink salmon returns are high."}

S01E = yearpermit[yearpermit$permit=="S01E",]
names(S01E)[which(names(S01E)=="year")]="Year"

returns = readxl::read_excel("../../salmon/paper/salmon_returns_PWS.xlsx")
pinkPWS = returns[,c("Year", "Pink_total", "Chum_total")]
pinkPWS = pinkPWS[which(pinkPWS$Year >= 1985),]
pinkPWS$diff = c(NA, diff(log(pinkPWS$Pink_total)))

pinkPWS = dplyr::left_join(pinkPWS, S01E)

# bring in slopes from above
slopes = df_s01e_b1[df_s01e_b1$permits=="S01E" & df_s01e_b1$diversity==1,]
slopes = slopes[,c("years","pred")]
names(slopes)[which(names(slopes)=="years")] = "Year"
names(slopes)[which(names(slopes)=="pred")] = "B1"
pinkPWS = dplyr::left_join(pinkPWS, slopes)

ggplot(data=pinkPWS, aes(b0, diff)) + geom_point() + stat_smooth(method=lm) + xlab("Estimated intercept from model") + ylab("Change in total pink salmon returns")

pinkPWS$diffchum = c(NA, diff(log(pinkPWS$Chum_total)))

prices = group_by(cfec[which(cfec$p_fshy%in%c("S 01E","S 03E") & cfec$spec%in%c("PINK","CHUM","SOCK")),], year, spec) %>% 
  summarize(meanPrice = mean(g_price)) %>%
  arrange(year)
prices <- dcast(melt(prices, id.vars = c("spec", "year")), year ~ variable+spec)
names(prices)[which(names(prices)=="year")]="Year"

pinkPWS = dplyr::left_join(pinkPWS, prices)
pinkPWS$pricediffchum = c(NA, diff(pinkPWS$meanPrice_CHUM))
pinkPWS$pricediffpink = c(NA, diff(pinkPWS$meanPrice_PINK))
pinkPWS$pricediffsock = c(NA, diff(pinkPWS$meanPrice_SOCK))

#cor(pinkPWS[,-c(5,6)], use="pairwise.complete.obs")

#ggplot(data=pinkPWS, aes(b0, B1)) + geom_point() + stat_smooth(method=lm) + xlab("Estimated intercept from model") + ylab("Change in total pink salmon returns")

#diversity = dplyr::group_by(dat.salmon[dat.salmon$strategy_permit=="S01E",], year) %>%
#  summarize(meanDiv = mean(specDiv))
#names(diversity)[which(names(diversity)=="year")] = "Year"
#pinkPWS = dplyr::left_join(pinkPWS, diversity)

```
  
  
\break  
  
  
# References
