---
title: "Results for working group papers"
author: "Catch portfolios subgroup: NCEAS meeting 3"
date: "March 18, 2016"
output:
  pdf_document:
    fig_caption: yes
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE)
```

## Load cleaned data  
```{r dataLoad, warning = FALSE, message=FALSE}
library(dplyr)
library(knitr)
library(mgcv)
library(ggplot2)
library(randomForest)
library(MASS)
library(MatchIt)
load("cfecCleaned.Rdata")
```


```{r, warning = FALSE, message=FALSE}
# This is to investigate Bristol Bay set nets for Milo
# Check BB setnet records / year
#idx = grep("S 04T", cfec$p_fshy)
#group_by(cfec[idx,], year) %>% 
#  summarize(nSetnet = length(unique(p_holder)))
#cfecnew = cfec[idx,]
```

## Function definiton  
We need to define a few functions for calculating diversity. We'll use the Simpson's diversity index (HHH) to calculate the entropy-based inverse, which is a proxy for effective species diversity. Note the C++ version is commented out below,   
```{r, warning = FALSE, message=FALSE}

simp.div = function(x) {
  1/sum((x/sum(x))^2)
}

#library(Rcpp)
#cppFunction('double simpCpp(NumericVector x) {
#  double y = 1/sum((x/sum(x))^2);
#  return y;
#}')
```

# Paper 2: Investigating relative effects of management changes (IFQ) relative to EVOS
### Alan's tenatively co-leading  

We'll restrict our analysis initially to a few years before and after the IFQ change, in 1995. People had to land halibut or sablefish in 1988, 1989, or 1990 to qualify for quota, and 5 of their best 6 years fished were used to calculate quota (so continuous fishing not a requirement). Alan's previously used 1992:1994 versus 1995:1997. We'll slightly expand this range initially, but may want to change it. [Side note: Eric and Sean already explored this, and there's no qualitative difference between the shorter/longer time periods].  

Alan defined 4 primary groups of individuals (or vessels):  
1. Individuals who fished halibut / sablefish before and after 1995 (IFQ group)  
2. Individuals who only fished halibut / sablefish before 1995 ["Pre"]
3. Individuals who only fished halibut / sablefish after 1995 ["Post"]  
4. Individuals who never fished halibut / sablefish ["Control group"]  

```{r, warning = FALSE, message=FALSE}
# We'll use 3 years before/after IFQ. This is consistent with the work that
# Alan has done. Years up to 1990 were included in the calculation of future
# quota, and 1998 is problematic because the ratio of our halibut earnings to 
# AKFIN's is ~ 60% -- suggesting there may be something systemic that we're
# missing. 
cfec$year = as.numeric(cfec$year)

dat = cfec[cfec$year %in% seq(1992,1997),]
#dat$p_holder = NULL
#dat = rename(dat, p_holder = cadfg)

# Create an indicator for species codes halibut (200) and sablefish (710)
dat$HS = 0
dat$HS[dat$g_earn > 0 & dat$specn%in%c(200, 710)] = 1

# Create a data frame that we'll use to assign years to pre- and post- groups  
df.years = data_frame(year=1992:1997, 
  ind = c(rep("Pre",3), rep("Post",3)))
dat =left_join(dat, df.years)
dat$ind = factor(dat$ind, levels = c("Pre","Post"))

dat.hs = group_by(dat, p_holder, ind) %>% 
  summarize(HS = sum(g_earn[HS==1]) > 0 ) 
hs.tbl = reshape2::dcast(dat.hs , p_holder ~ ind)
hs.tbl$Post[is.na(hs.tbl$Post)] = FALSE
hs.tbl$Pre[is.na(hs.tbl$Pre)] = FALSE

# Assign groups
hs.tbl = mutate(hs.tbl, group = ifelse(Post & Pre, "IFQ", 
  ifelse(Post & !Pre, "Post.only", 
    ifelse(!Post & Pre, "Pre.only", "Cntl"))))

dat = left_join(dat, hs.tbl)

# Even though we initially defined a control group, get rid of it because
# after a lot of group discussion, these people are not true controls:
dat = dat[dat$group != "Cntl", ]
```

## IFQ Results:  
We want to look at a number of different responses, based on revenue (mean revenue, and variability in revenue) as well as metrics of diversity (species) and metrics of effort or participation (days fished, etc).  

```{r, cache = TRUE, warning = FALSE, message=FALSE}

# Convert date string to a character -- we only care about unique values
dat$day = substr(dat$landdate, 6, 10)

# We're first going to group over the indicator (pre-post), group, individual (p_holder), 
# and year. We'll calculate total revenue, total revenue made up of halibut or sablefish, 
# total pounds, total pounds made up of halibut or sablefish, effective species diversity, 
# effective gear diversity (which is likely not that interesting since most of these 
# individuals are landing halibut/sablefish on longlines), # days fished per year. 
# Second, we'll then aggregate these annual metrics across years to calculate means and 
# CVs, when possible (the CV == 0 when 2 years of participation present, NA with 1 year). 
# We'll make no restriction about # of years that someone needs to participate either 
# before or after 1995 [side note: Eric and Sean looked at this, and qualitatively, 
# results don't change]. Taking the mean of the 'annual means' will also allow us to 
# compare the revenue of someone who fishes say ~ 4 years pre-IFQ and 1 year post-IFQ.  

hs.summary = group_by(dat, ind, group, p_holder, year) %>% 
  summarize(tot.revenue.ind = sum(g_earn), 
    tot.revenue.ind.h = sum(g_earn[specn==200]), 
    tot.revenue.ind.s = sum(g_earn[specn==710]),
    tot.pounds.ind = sum(g_pounds), 
    tot.pounds.ind.h = sum(g_pounds[specn==200]), 
    tot.pounds.ind.s = sum(g_pounds[specn==710]),
    eff.spec.div = simp.div(table(specn)), 
    eff.gear.div = simp.div(table(gearn)),
    numDays = length(unique(day)),
    numHalibutDays = length(unique(day[specn==200]))) %>% 
  as.data.frame %>% 
  group_by(ind, group, p_holder) %>% 
  summarize(cv.revenue.ind = sd(tot.revenue.ind,na.rm=T) / mean(tot.revenue.ind,na.rm=T),
    mean.revenue.ind = mean(tot.revenue.ind,na.rm=T), 
    mean.revenue.ind.h = mean(tot.revenue.ind.h,na.rm=T),
    mean.revenue.ind.s = mean(tot.revenue.ind.s,na.rm=T),
    mean.pounds.ind = mean(tot.pounds.ind,na.rm=T),
    mean.pounds.ind.h = mean(tot.pounds.ind.h,na.rm=T),
    mean.pounds.ind.s = mean(tot.pounds.ind.s,na.rm=T),
    eff.spec.div.cv = sd(eff.spec.div,na.rm=T)/mean(eff.spec.div,na.rm=T),
    eff.spec.div.mean = mean(eff.spec.div,na.rm=T),
    eff.gear.div.cv = sd(eff.gear.div,na.rm=T)/mean(eff.gear.div,na.rm=T),
    eff.gear.div.mean = mean(eff.gear.div,na.rm=T),
    records.per.ind = n(), nYears = length(unique(year)), 
    nDays = mean(numDays, na.rm=T),
    nHalibutDays = mean(numHalibutDays, na.rm=T)) 

# Here we calculate the weighted diversity metrics. 
# We'll generate 3 versions of the estimates to make sure the results are robust:  
# 1. Diversity based on frequency in fish tickets  
# 2. Diversity weighted by sum of earnings  
# 3. Diversity weighted by sum of biomass (catch, in pounds)  
hs.div = group_by(dat, ind, group, p_holder, year, specn) %>% 
  summarize(tot.weight.sp = sum(g_pounds), 
    tot.revenue.sp = sum(g_earn)) %>% 
  group_by(ind, group, p_holder, year) %>% 
  summarize(eff.spec.div.mean.earn = simp.div(tot.revenue.sp),
    eff.spec.div.mean.weight = simp.div(tot.weight.sp)) %>%
  group_by(ind, group, p_holder) %>% 
  summarize(eff.spec.div.cv.earn = 
      sd(eff.spec.div.mean.earn) / mean(eff.spec.div.mean.earn), 
    eff.spec.div.mean.earn = mean(eff.spec.div.mean.earn), 
    eff.spec.div.cv.weight = 
      sd(eff.spec.div.mean.weight) / mean(eff.spec.div.mean.weight),
    eff.spec.div.mean.weight = mean(eff.spec.div.mean.weight))
hs.summary = left_join(hs.summary, hs.div)

# Calculate vessels used per individual and join
vessels.per.ind = group_by(dat, ind, group, p_holder) %>% 
  summarize(boat.per.ind = length(unique(cadfg)))
hs.summary = left_join(hs.summary, vessels.per.ind)

# We proposed calculating diversity across fish tix -- but that's impossible because
# each fish ticket is delivery of a single species. But we can calculate the diversity 
# by day (lumping all catch / fish tickets for that day). 

# This is a bit complicated, so we'll do it using a series of group_by statements that are 
# broken out here for clarity. First, calculate total weight, earnings, and 
# frequency (counts) over species by fish ticket, year, indicator, and group
hs.day = group_by(dat, ind, group, p_holder, year, day, specn) %>% 
  summarize(tot.weight.sp = sum(g_pounds), 
    tot.earn.sp = sum(g_earn), 
    tot.freq.sp = n()) %>%
  as.data.frame

# Second, calculate the diversity metrics integrating across species. We can also calculate 
# the derived proportion of halibut and sablefish that are contributing to individual 
# fish tickets (so that we can examine the distribution of these across days)
hs.day = group_by(hs.day, ind, group, p_holder, year, day) %>% 
  summarize(pHal.weight = sum(tot.weight.sp[specn==200])/sum(tot.weight.sp), 
    pHal.earn = sum(tot.earn.sp[specn==200])/sum(tot.earn.sp), 
    pHal.freq = sum(tot.freq.sp[specn==200])/sum(tot.freq.sp), 
    pSabl.weight = sum(tot.weight.sp[specn==710])/sum(tot.weight.sp), 
    pSabl.earn = sum(tot.earn.sp[specn==710])/sum(tot.earn.sp), 
    pSabl.freq = sum(tot.freq.sp[specn==710])/sum(tot.freq.sp), 
    tot.weight.sp = simp.div(tot.weight.sp), 
    tot.earn.sp = simp.div(tot.earn.sp), 
    tot.freq.sp = simp.div(tot.freq.sp)) %>% 
  as.data.frame()

# Third, we'll calculate the quantiles of these metrics across fish tickets. This will 
# help us plot the CDF style plots  
hs.day.summary = group_by(hs.day, ind, group, year) %>% 
  summarize(l.weight = quantile(tot.weight.sp, 0.25, na.rm=TRUE), 
    m.weight = quantile(tot.weight.sp, 0.5, na.rm=TRUE), 
    u.weight = quantile(tot.weight.sp, 0.75, na.rm=TRUE),
    l.freq = quantile(tot.freq.sp, 0.25, na.rm=TRUE), 
    m.freq = quantile(tot.freq.sp, 0.5, na.rm=TRUE), 
    u.freq = quantile(tot.freq.sp, 0.75, na.rm=TRUE), 
    l.earn = quantile(tot.earn.sp, 0.25, na.rm=TRUE), 
    m.earn = quantile(tot.earn.sp, 0.5, na.rm=TRUE), 
    u.earn = quantile(tot.earn.sp, 0.75, na.rm=TRUE), 
    l.hal.earn = quantile(pHal.earn, 0.25, na.rm=TRUE),
    m.hal.earn = quantile(pHal.earn, 0.5, na.rm=TRUE), 
    u.hal.earn = quantile(pHal.earn, 0.75, na.rm=TRUE), 
    l.hal.weight = quantile(pHal.weight, 0.25, na.rm=TRUE), 
    m.hal.weight = quantile(pHal.weight, 0.5, na.rm=TRUE), 
    u.hal.weight = quantile(pHal.weight, 0.75, na.rm=TRUE),
    l.hal.freq = quantile(pHal.freq, 0.25, na.rm=TRUE), 
    m.hal.freq = quantile(pHal.freq, 0.5, na.rm=TRUE), 
    u.hal.freq = quantile(pHal.freq, 0.75, na.rm=TRUE),
    l.sab.earn = quantile(pSabl.earn, 0.25, na.rm=TRUE), 
    m.sab.earn = quantile(pSabl.earn, 0.5, na.rm=TRUE), 
    u.sab.earn = quantile(pSabl.earn, 0.75, na.rm=TRUE),
    l.sab.weight = quantile(pSabl.weight, 0.25, na.rm=TRUE), 
    m.sab.weight = quantile(pSabl.weight, 0.5, na.rm=TRUE), 
    u.sab.weight = quantile(pSabl.weight, 0.75, na.rm=TRUE),
    l.sab.freq = quantile(pSabl.freq, 0.25, na.rm=TRUE), 
    m.sab.freq = quantile(pSabl.freq, 0.5, na.rm=TRUE), 
    u.sab.freq = quantile(pSabl.freq, 0.75, na.rm=TRUE))

```

```{r, fig.pos="placeHere", fig.cap="Plot of species diversity metrics (calculated by fish ticket freq.) through time for each of our 4 groups during the pre-post IFQ period. "}
ggplot(hs.day.summary, aes(year, m.freq)) + geom_line() + facet_wrap(~group) + 
  geom_ribbon(aes(ymin=l.freq, ymax=u.freq), alpha=0.2)
```

```{r, fig.pos="placeHere", fig.cap="Plot of species diversity metrics (calculated by earnings) through time for each of our 4 groups during the pre-post IFQ period. "}
ggplot(hs.day.summary, aes(year, m.earn)) + geom_line() + facet_wrap(~group) + 
  geom_ribbon(aes(ymin=l.earn, ymax=u.earn), alpha=0.2)
```

```{r, fig.pos="placeHere", fig.cap="Plot of species diversity metrics (calculated by pounds of catch) through time for each of our 4 groups during the pre-post IFQ period. "}
ggplot(hs.day.summary, aes(year, m.weight)) + geom_line() + facet_wrap(~group) + 
  geom_ribbon(aes(ymin=l.weight, ymax=u.weight), alpha=0.2)
```

Getting back to the comparisons between groups (aggregated over years in our pre-post IFQ groupings), we can convert the landed halibut and sablefish revenue and weight into a proportion of the total catch.  

First, make a dotplot (with quartile range) of the pre-post comparison for each metric of revenue.  
```{r, fig.pos="placeHere", fig.cap = "Metric of annual revenue, with interquartile range, for each of the 4 IFQ groups."}

hs.summary$mean.revenue.ind.h = 
  hs.summary$mean.revenue.ind.h / hs.summary$mean.revenue.ind
hs.summary$mean.revenue.ind.s = 
  hs.summary$mean.revenue.ind.s / hs.summary$mean.revenue.ind
hs.summary$mean.pounds.ind.h = 
  hs.summary$mean.pounds.ind.h / hs.summary$mean.pounds.ind
hs.summary$mean.pounds.ind.s = 
  hs.summary$mean.pounds.ind.s / hs.summary$mean.pounds.ind

dplyr::select(hs.summary, group, ind, p_holder, 
  contains("mean"), -contains("div")) %>%
  reshape2::melt(id.vars = c("group", "ind","p_holder")) %>%
  group_by(group, ind, variable) %>% 
  filter(is.na(value)==F) %>% 
  summarize(l = quantile(value, 0.25, na.rm=T), 
    u = quantile(value, 0.75, na.rm=T), 
    m = quantile(value, 0.5, na.rm=T)) %>%
  ggplot(aes(x = ind, y = m, ymax = u, ymin = l)) + 
  geom_pointrange() + facet_grid(variable ~ group, scales="free")

```

Look at the mean number of days where catch was recorded as landed, as well as how many of those days are when halibut are landed.  
```{r}
dplyr::select(hs.summary, group, ind, p_holder, 
  contains("nDays"), contains("nHalibutDays")) %>%
  reshape2::melt(id.vars = c("group", "ind","p_holder")) %>%
  group_by(group, ind, variable) %>% 
  filter(is.na(value)==F) %>% 
  summarize(l = quantile(value, 0.25, na.rm=T), 
    u = quantile(value, 0.75, na.rm=T), 
    m = quantile(value, 0.5, na.rm=T)) %>%
  ggplot(aes(x = ind, y = m, ymax = u, ymin = l)) + 
  geom_pointrange() + facet_grid(variable ~ group, scales="free")
```


```{r, fig.pos="placeHere", fig.cap = "Boxplots of revenue metrics (with interquartile range) by group and pre-post-IFQ. ", include=FALSE, echo=FALSE, message = FALSE, warning = FALSE}
#dplyr::select(hs.summary, group, ind, p_holder, contains("mean"), -contains("div")) %>% 
#  reshape2::melt(id.vars = c("group", "ind","p_holder")) %>%
#  ggplot(aes(ind, value)) + geom_boxplot(aes(fill=ind), alpha=0.5, outlier.size=NA) + 
#  facet_grid(variable ~ group, scales="free")
```

```{r, fig.pos="placeHere", fig.cap = "Boxplots of diversity metrics (with interquartile range) by group and pre-post-IFQ. "}
dplyr::select(hs.summary, group, ind, p_holder, contains("eff.spec.div.mean"), contains("eff.gear.div.mean"), contains("eff.spec.div.mean")) %>% 
  reshape2::melt(id.vars = c("group", "ind","p_holder")) %>%
  ggplot(aes(ind, value)) + 
  geom_boxplot(aes(fill=ind), alpha=0.5, outlier.size=NA) + 
  facet_grid(variable ~ group, scales="free")
# +  geom_point(alpha = 0.02, position = position_jitter(width = 0.4), cex = 0.2)

```

```{r, fig.pos="placeHere", fig.cap="Violin plot of individual differences (post-IFQ - pre-IFQ for the revenue and diversity metrics included in our analysis."}
hs.long = reshape2::melt(hs.summary, id.vars = c("group", "ind","p_holder"))
hs.long = reshape2::dcast(hs.long, variable + p_holder + group ~ ind) %>%
  mutate(diff_ = (Post-Pre)/Pre)

ggplot(hs.long, aes(group, diff_)) + 
  geom_violin(aes(fill=group), alpha=0.5) + 
  facet_wrap(~ variable, scales="free") +
  geom_point(alpha = 0.02, position = 
      position_jitter(width = 0.4), cex = 0.2)
```

## Changes in gear diversity through time  
Let's look at the change in gear diversity through time for each of the 4 groups in our analysis. 
We'll start with effective gear diversity, by 

```{r, fig.pos = "placeHere", fig.cap = "Gear diversity through time for each of the 3 groups, calculated based on the catch (black) and earnings (red)."}
hs.summary.gear = group_by(dat, ind, group, year, gearn) %>% 
  summarize(n = n(), nEarn = sum(g_earn), nWeight = sum(g_pounds)) %>% 
  as.data.frame %>% 
  group_by(ind, group, year) %>% 
  summarize(gearDiv.freq = simp.div(n), 
    gearDiv.earn = simp.div(nEarn), 
    gearDiv.weight = simp.div(nWeight))

ggplot(hs.summary.gear, aes(year, gearDiv.weight)) + 
  geom_line() + facet_wrap(~ group, scales="free") + 
  geom_line(aes(year, gearDiv.earn), col="red")
```


We'll break down the proportion used for the top 8 gears,
```{r, fig.pos="placeHere", fig.cap = "Time series of proportion of gears used"}
hs.gear.tot = group_by(dat, ind, group, year) %>% 
  summarize(nTot = n())
hs.summary.gear = group_by(dat, ind, group, year, gearn) %>% 
  summarize(n = n()) %>%
  left_join(hs.gear.tot)
hs.summary.gear$p = hs.summary.gear$n/hs.summary.gear$nTot
hs.summary.gear = filter(hs.summary.gear, gearn %in% c(1,6,15,7,9,47,4,5)) %>% 
ggplot(aes(year, p)) + geom_line() + facet_grid(gearn ~ group, scales="free")

```

Can we predict effective species diversity as function of gear diversity?
```{r}
#hs.geardiv = group_by(dat, ind, group, p_holder, year, gearn) %>% 
#  summarize(tot.weight.sp = sum(g_pounds), 
#    tot.revenue.sp = sum(g_earn)) %>% 
#  group_by(ind, group, p_holder, year) %>% 
#  summarize(eff.gear.div.mean.earn = simp.div(tot.revenue.sp),
#    eff.gear.div.mean.weight = simp.div(tot.weight.sp)) %>%
#  group_by(ind, group, p_holder) %>% 
#  summarize(eff.gear.div.cv.earn = 
#      sd(eff.gear.div.mean.earn) / mean(eff.gear.div.mean.earn), 
#    eff.gear.div.mean.earn = mean(eff.gear.div.mean.earn), 
#    eff.gear.div.cv.weight = 
#      sd(eff.gear.div.mean.weight) / mean(eff.gear.div.mean.weight),
#    eff.gear.div.mean.weight = mean(eff.gear.div.mean.weight))
#hs.summary = left_join(hs.summary, hs.geardiv) %>% 
#  as.data.frame()
```

## EVOS comparison

We'll restrict our analysis initially to a few years before and after EVOS (1989). To make the comparison similar to the IFQ comparison, we will define the following groups:

1. Individuals who fished in closed areas before and after spill  
2. Individuals who fished in closed areas before spill ["Pre"]
3. Individuals who only fished in closed areas after 1995 ["Post"]  
4. Individuals who never fished in closed areas ["Control group"]  


## Propensity matching for EVOS
We're interested in forming a control group for the comparison of the EVOS effects...
```{r, warning = FALSE, message=FALSE}

# Don't include 1989, but include before / after
dat = cfec[cfec$year %in% c(1985:1988, 1990:1991),]
dat$day = substr(dat$landdate, 6, 10)
# Create an indicator based on the salmon / shellfish araes that were closed in PWS
dat$exposed = 0
dat$exposed[dat$stat6%in%c(22710, 22720, 22730, 22610, 22620, 22630, 22640, 22650, 22510, 22520, 22530)] = 1

# Exposed variable is the response, and we want to predict based on traits
dat.ev = group_by(dat, p_holder, year) %>% 
  summarize(tot.revenue.ind = sum(g_earn), 
    tot.revenue.ind.her = sum(g_earn[specn==230]), 
    tot.revenue.ind.sal = sum(g_earn[specn%in%c(400,410,420,430,440,450)]),
    tot.pounds.ind = sum(g_pounds), 
    tot.pounds.ind.her = sum(g_pounds[specn==230]), 
    tot.pounds.ind.sal = sum(g_pounds[specn%in%c(400,410,420,430,440,450)]),
    eff.spec.div = simp.div(table(specn)), 
    eff.gear.div = simp.div(table(gearn)),
    numDays = length(unique(day)),
    exposed = max(exposed), 
    ind = ifelse(year[1] < 1989, "Pre", "Post")) %>% 
    as.data.frame() %>%
  group_by(p_holder, ind) %>% 
  summarize(tot.revenue.ind = mean(tot.revenue.ind), 
    tot.revenue.ind.her = mean(tot.revenue.ind.her), 
    tot.revenue.ind.sal = mean(tot.revenue.ind.sal),
    tot.pounds.ind = mean(tot.pounds.ind), 
    tot.pounds.ind.her = mean(tot.pounds.ind.her), 
    tot.pounds.ind.sal = mean(tot.pounds.ind.sal),
    eff.spec.div = mean(eff.spec.div), 
    eff.gear.div = mean(eff.gear.div),
    exposed = max(exposed),
    meanDays = mean(numDays)) %>% 
    as.data.frame()

# fix exposure column 
dat.ev = group_by(dat.ev, p_holder) %>% 
  mutate(exposed = max(exposed)) %>% 
  as.data.frame()

# 1. Diversity based on frequency in fish tickets  
# 2. Diversity weighted by sum of earnings  
# 3. Diversity weighted by sum of biomass (catch, in pounds)  
ev.div = group_by(dat, p_holder, year, specn) %>% 
  summarize(ind = ifelse(year[1] < 1989, "Pre", "Post"), 
    tot.weight.sp = sum(g_pounds), 
    tot.revenue.sp = sum(g_earn)) %>% 
  group_by(ind, p_holder, year) %>% 
  summarize(eff.spec.div.mean.earn = simp.div(tot.revenue.sp),
    eff.spec.div.mean.weight = simp.div(tot.weight.sp)) %>%
  group_by(ind, p_holder) %>% 
  summarize(eff.spec.div.cv.earn = 
      sd(eff.spec.div.mean.earn) / mean(eff.spec.div.mean.earn), 
    eff.spec.div.mean.earn = mean(eff.spec.div.mean.earn), 
    eff.spec.div.cv.weight = 
      sd(eff.spec.div.mean.weight) / mean(eff.spec.div.mean.weight),
    eff.spec.div.mean.weight = mean(eff.spec.div.mean.weight))
dat.ev = left_join(dat.ev, ev.div)

# Filter out only individulas with pre / post (2 rows)
dat.ev.count = group_by(dat.ev, p_holder) %>% 
  summarize(n = n()) %>%
  filter(n == 2) %>% 
  as.data.frame

dat.ev = inner_join(dat.ev, dplyr::select(dat.ev.count, p_holder))

# Only find matches based on pre-EVOS data. We can then compare pre/post effects

dat.ev$eff.spec.div.cv.earn = NULL
dat.ev$eff.spec.div.cv.weight = NULL

dat.ev.rf = filter(dat.ev, ind == "Pre")

#rf = randomForest(x = dat.ev.rf, y = as.factor(dat.ev.rf$exposed))

dat.ev.rf[,3:8] = log(dat.ev.rf[,3:8] + 1)

m.glm = glm(exposed ~ ., data = dat.ev.rf[dat.ev.rf$ind=="Pre", -c(1,2)], family = "binomial")
stepAIC(m.glm, direction="both")

bestModel = glm(exposed ~ tot.revenue.ind.her + tot.revenue.ind.sal + 
    tot.pounds.ind + tot.pounds.ind.her + tot.pounds.ind.sal + 
    eff.spec.div + meanDays + eff.spec.div.mean.weight, data = 
    dat.ev.rf[dat.ev.rf$ind == "Pre", ])

m.out <- matchit(exposed ~ tot.revenue.ind + tot.revenue.ind.her + 
    tot.revenue.ind.sal + tot.pounds.ind + tot.pounds.ind.her + 
    tot.pounds.ind.sal + eff.spec.div + eff.gear.div + meanDays + 
    eff.spec.div.mean.earn, method = "nearest", data = dat.ev.rf[dat.ev.rf$ind == 
    "Pre", ])

matches = match.data(m.out)

#m.out <- matchit(exposed, method = "nearest", data = dat.ev[dat.ev$ind==0,], distance = rf$votes[,2])

dat.matched = dat.ev[dat.ev$p_holder %in% unique(matches$p_holder), ]

fn_bal <- function(dta, variable) {
    dta$variable <- dta[, variable]
    ggplot(dta, aes(y = distance, x = variable, color = as.factor(exposed))) +
      geom_point(alpha = 0.2, size = 1.5) +
      geom_smooth(method = "loess", se = F) +
      ylab("Propensity score") +
      xlab(variable) + 
      theme_bw()  
}
fn_bal(matches, "tot.revenue.ind")

dat.matched$plotind = ifelse(dat.matched$ind == "Pre", 0, 1)
dat.matched$ind2 = dat.matched$plotind
dat.matched$ind2[dat.matched$exposed==1] = dat.matched$ind2[dat.matched$exposed==1] + 0.2

dat.matched.summary = reshape2::melt(dat.matched, id.vars = c("exposed","ind", "p_holder")) %>%
  group_by(ind, exposed, variable) %>% 
  filter(is.na(value)==F) %>% 
  summarize(l = quantile(value, 0.25, na.rm=T), 
    u = quantile(value, 0.75, na.rm=T), 
    m = quantile(value, 0.5, na.rm=T))
dat.matched.summary$ind2 = as.numeric(as.factor(dat.matched.summary$ind)) - 1
dat.matched.summary$ind2[dat.matched.summary$exposed==1] = dat.matched.summary$ind2[dat.matched.summary$exposed==1] + 0.2

ggplot(dat.matched.summary, aes(x = ind2, y = m, ymax = u, ymin = l, col = as.factor(exposed))) + geom_pointrange() + facet_wrap(~ variable, scales="free")

```

```{r}

ev.long = reshape2::melt(dat.matched, id.vars = c("exposed","ind","p_holder"))
ev.long = reshape2::dcast(ev.long, variable + p_holder + exposed ~ ind) %>%
  mutate(diff_ = (Post-Pre)/Pre)

ev.long = filter(ev.long, !is.na(diff_), is.finite(diff_))
ggplot(ev.long, aes(exposed, diff_)) + 
  geom_violin(aes(fill=exposed), alpha=0.5) + 
  facet_wrap(~ variable, scales="free") +
  geom_point(alpha = 0.02, position = 
  position_jitter(width = 0.4), cex = 0.2)
  
```

```{r}
#cfec$areaPermit = 0
#cfec$areaPermit[grep("B", cfec$p_fshy)] = 1
#cfec$areaPermit[grep("G", cfec$p_fshy)] = 1

#permitTypes = group_by(cfec, p_holder) %>% 
#summarize(nState = length(which(areaPermit==1)), n = length(which(areaPermit==0))) %>% as.data.frame()

# 41113 individuals
# 18383 just have regional permits, 12251 just have statewide/GOA, 10479 have both
#length(which(permitTypes$nState==0 & permitTypes$n > 0))
```
