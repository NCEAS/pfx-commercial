---
title: "createData_linear_modeling"
author: ""
date: "June 05, 2016"
output:
  pdf_document:
    fig_caption: yes
  html_document: default
---

## Modifications from un-differenced filtering:  
### 1. No threshold for people to be included (e.g. 10+ years)
### 2. Inclusion of everyone, regardless of permits fished
### 3. Excluding observations that we don't have consecutive years for
### 4. Some permits lumped -- especially those based on vessel sizes

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE)
```

## Load cleaned data  
```{r dataLoad, warning = FALSE, message=FALSE, results="hide", echo=FALSE}
library(dplyr)
library(knitr)
library(ggplot2)
library(date)

#load("cfecCleaned2.Rdata")
cfec <- feather::read_feather("data/cfec.feather")

# convert 6-dig p_fshy codes to 5 digits
# removing blank space - now they're all length(5)
idx = which(nchar(cfec$p_fshy)==6)
cfec$p_fshy[idx] = paste(substr(cfec$p_fshy[idx], 1, 1), 
  substr(cfec$p_fshy[idx], 3, 6), sep="")

# remove white space in 2nd position
idx = which(substr(cfec$p_fshy, 2, 2) == " ")
cfec$p_fshy[idx] = paste(substr(cfec$p_fshy[idx], 1, 1), 
  substr(cfec$p_fshy[idx], 3, length(cfec$p_fshy[idx])), sep="")

region<-read.csv("areas/regions.csv")
region<-region[,c(1:2)] #don’t include “assigned by” column
cfec<-left_join(cfec,region)
#cfec$region <- replace(cfec$region, is.na(cfec$region), "Unassigned")
```

We need to adjust the landed values and prices for inflation. To do this, we'll use the data Alan pulled together (adjusting to 2009 dollars). 

https://docs.google.com/spreadsheets/d/1hRLYTX1nZBLKnYXwTCOtU7-XnDoMZf_1ufdTiNQFd4U/edit#gid=0

```{r, echo=FALSE}
deflationTable = data.frame(year = 1985:2014, defl = c(0.57236, 0.58393, 0.59879, 0.61974,  
0.64388, 0.66774, 0.68993, 0.70564, 0.72244, 0.73781,  
0.75321, 0.76695, 0.78009, 0.78855, 0.80061,  
0.81883, 0.83753, 0.85038, 0.86729, 0.89114,  
0.91981, 0.94812, 0.97334, 0.9925, 1,  
1.01217, 1.03307, 1.05213, 1.06926, 1.08682))

# Adjust price and g_earn for inflation
cfec$year = as.numeric(cfec$year)
cfec$day = substr(cfec$landdate, 6, 10)
cfec$g_price = cfec$g_price/deflationTable$defl[cfec$year-1984]
cfec$g_earn = cfec$g_earn/deflationTable$defl[cfec$year-1984]
```

### Function definiton  
We need to define a few functions for calculating diversity. We'll use the Simpson's diversity index (HHI) to calculate the entropy-based inverse, which is a proxy for effective species diversity. Note the C++ version is commented out below,   

```{r, warning = FALSE, message=FALSE, echo=FALSE}
simp.div = function(x) {
  1/sum((x/sum(x))^2)
}
```

## Filtering out unique vessel - person combinations. Drops rows from 17 to 13 million.   

Now we'll filter out individuals who only used 1 boat in a year, and boats with only one permit holder fishing in a year.  

```{r}
cfecnew = cfec
cfec.1boat = group_by(cfecnew, p_holder, year) %>% 
  summarize(nBoat = length(unique(cadfg))) %>%
  filter(nBoat==1) %>% 
  left_join(cfecnew)

cfecnew = cfec.1boat
dim(cfecnew)[1]
```

## Aggregate some permits, especially some of the longline/trawl ones based on vessel size, for which reporting is also variable  

```{r}
cfecnew$p_fshy[cfecnew$p_fshy=="B61B"] = "B06B"
cfecnew$p_fshy[cfecnew$p_fshy=="C61B"] = "C06B"
cfecnew$p_fshy[cfecnew$p_fshy=="C91B"] = "C09B"
cfecnew$p_fshy[cfecnew$p_fshy=="M61B"] = "M06B"
cfecnew$p_fshy[cfecnew$p_fshy=="E09B"] = "E91B"
cfecnew$p_fshy[cfecnew$p_fshy=="I06B"] = "I61B"
cfecnew$p_fshy[cfecnew$p_fshy=="Y06A"] = "Y61A"
cfecnew$p_fshy[cfecnew$p_fshy=="O06B"] = "O61B"
cfecnew$p_fshy[cfecnew$p_fshy=="O09B"] = "O91B"

cfecnew$p_fshy[cfecnew$p_fshy%in%c("M7FB","M7GB", "M7HB","M7IB")] = "M7IB"
cfecnew$p_fshy[cfecnew$p_fshy%in%c("M7FG","M7GG", "M7HG","M7IG")] = "M7IG"

# crab and shrimp vessels 
cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="D91")] = paste("D09", substr(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="D91")],4,length(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="D91")])), sep="")
cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="T91")] = paste("T09", substr(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="T91")],4,length(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="T91")])), sep="")
cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="P91")] = paste("P09", substr(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="P91")],4,length(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="P91")])), sep="")

cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="M91")] = paste("M09", substr(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="M91")],4,length(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="M91")])), sep="")
cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="M61")] = paste("M06", substr(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="M61")],4,length(cfecnew$p_fshy[which(substr(cfecnew$p_fshy,1,3)=="M61")])), sep="")
```


## Identify most popular strategies by person-year combination

###For variability, any person in a year will need to have 10% or more of their revenue to come from each permit (otherwise doesn't count as a strategy)

The top 120 permits cuts the rows down to 8.6 million. The top 50 gets it down to 7.8 million. 
  
```{r}
permit_rev = group_by(cfecnew, p_holder, year, p_fshy) %>% 
  summarize(permit.rev = sum(g_earn)) %>% 
  as.data.frame() %>% 
  group_by(p_holder, year) %>% 
  mutate(tot.rev = sum(permit.rev))
permit_rev$permit.rev = permit_rev$permit.rev/permit_rev$tot.rev # fraction of total
permit_rev = permit_rev[permit_rev$permit.rev < 0.1,]

# Delete these minimal earnings
cfecnew = cfecnew[-which(paste(cfecnew$p_holder, cfecnew$year, cfecnew$p_fshy) %in% paste(permit_rev$p_holder, permit_rev$year, permit_rev$p_fshy))]

topstrategies = group_by(cfecnew, p_holder, year) %>% 
  summarize(strategy = paste(sort(unique(p_fshy)), collapse = " ")) %>%
  as.data.frame()
cfecnew = left_join(cfecnew, topstrategies) # adds strategy column

#CUTOFF = 100
#cfecnew = cfecnew[cfecnew$strategy%in%names(rev(sort(table(topstrategies$strategy)))[1:CUTOFF]), ]
```

Aggregate annual metrics by person, 

```{r}

cfecnew$day = mdy.date(as.numeric(lapply(strsplit(cfecnew$day, "-"), getElement, 1)), as.numeric(lapply(strsplit(cfecnew$day, "-"), getElement, 2)), cfecnew$year) - mdy.date(1, 1, cfecnew$year)

cfecAnnual = group_by(cfecnew, p_holder, year) %>%
  summarize(permit = p_fshy[1], boat = cadfg2[1], 
    days = diff(range(day) + 1), 
    ngear = length(unique(gearn)),
    nspec = length(unique(specn)),
    npermit = length(unique(p_fshy)),
    revenue = sum(g_earn),
    length = mean(VLength, na.rm=T),
    strategy = strategy[1],
    weight = sum(g_pounds)) 

# also calculate weighted simpson diversity of gears and species
cfecAnnual = left_join(cfecAnnual, group_by(cfecnew, p_holder, year, specn) %>% 
  summarize(totRev.spec = sum(g_earn)) %>% 
  group_by(p_holder, year) %>% 
  summarize(specDiv = simp.div(totRev.spec)))

# also calculate weighted simpson diversity of gears and species
cfecAnnual = left_join(cfecAnnual, group_by(cfecnew, p_holder, year, gearn) %>% 
  summarize(totRev.gear = sum(g_earn)) %>% 
  group_by(p_holder, year) %>% 
  summarize(gearDiv = simp.div(totRev.gear)))

# Also merge in previous revenue. Idx stores index of people last year
idx = match(paste(cfecAnnual$p_holder,cfecAnnual$year-1), paste(cfecAnnual$p_holder,cfecAnnual$year))

cfecAnnual$permit.prev = cfecAnnual$permit[idx]
cfecAnnual$ngear.prev = cfecAnnual$ngear[idx]
cfecAnnual$nspec.prev = cfecAnnual$nspec[idx]
cfecAnnual$npermit.prev = cfecAnnual$npermit[idx]
cfecAnnual$revenue.prev = cfecAnnual$revenue[idx]
cfecAnnual$specdiv.prev = cfecAnnual$specDiv[idx]
cfecAnnual$geardiv.prev = cfecAnnual$gearDiv[idx]
cfecAnnual$strategy.prev = cfecAnnual$strategy[idx]
cfecAnnual$weight.prev = cfecAnnual$weight[idx]
cfecAnnual$days.prev = cfecAnnual$days[idx]
#cfecAnnual$p2.prev = cfecAnnual$p2[idx]

cfecAnnual$specDiv.change = cfecAnnual$specDiv - cfecAnnual$specdiv.prev

cfecAnnual.diff = cfecAnnual[is.na(cfecAnnual$specDiv.change)==F, ]

saveRDS(cfecAnnual.diff, file="diff_linearModeling_complete.rds")

# 4200 different strategies, need to model only most common, 
top.strategies = names(rev(sort(table(cfecAnnual.diff$strategy)))[1:100])

cfecAnnual.diff = cfecAnnual.diff[cfecAnnual.diff$strategy%in%top.strategies, ]
# idx = which(cfecAnnual.diff$strategy != cfecAnnual.diff$strategy.prev)
# paste(cfecAnnual.diff$strategy.prev[idx], cfecAnnual.diff$strategy[idx], sep=":")
cfecAnnual.diff = cfecAnnual.diff[which(cfecAnnual.diff$strategy == cfecAnnual.diff$strategy.prev), ]

saveRDS(cfecAnnual.diff, file="diff_linearModeling_subset.rds")

```
