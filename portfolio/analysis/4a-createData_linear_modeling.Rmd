---
title: "createData_linear_modeling"
author: ""
date: "June 05, 2016"
output:
  pdf_document:
    fig_caption: yes
  html_document: default
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE)
```

## Load cleaned data  
```{r dataLoad, warning = FALSE, message=FALSE, results="hide", echo=FALSE}
library(dplyr)
library(knitr)
library(ggplot2)
library(date)

#load("cfecCleaned2.Rdata")
cfec <- feather::read_feather("data/cfec.feather")

# convert 6-dig p_fshy codes to 5 digits
# removing blank space - now they're all length(5)
idx = which(nchar(cfec$p_fshy)==6)
cfec$p_fshy[idx] = paste(substr(cfec$p_fshy[idx], 1, 1), 
  substr(cfec$p_fshy[idx], 3, 6), sep="")

# remove white space in 2nd position
idx = which(substr(cfec$p_fshy, 2, 2) == " ")
cfec$p_fshy[idx] = paste(substr(cfec$p_fshy[idx], 1, 1), 
  substr(cfec$p_fshy[idx], 3, length(cfec$p_fshy[idx])), sep="")

region<-read.csv("areas/regions.csv")
region<-region[,c(1:2)] #don’t include “assigned by” column
cfec<-left_join(cfec,region)
#cfec$region <- replace(cfec$region, is.na(cfec$region), "Unassigned")
```

We need to adjust the landed values and prices for inflation. To do this, we'll use the data Alan pulled together (adjusting to 2009 dollars). 

https://docs.google.com/spreadsheets/d/1hRLYTX1nZBLKnYXwTCOtU7-XnDoMZf_1ufdTiNQFd4U/edit#gid=0

```{r, echo=FALSE}
deflationTable = data.frame(year = 1985:2014, defl = c(0.57236, 0.58393, 0.59879, 0.61974,  
0.64388, 0.66774, 0.68993, 0.70564, 0.72244, 0.73781,  
0.75321, 0.76695, 0.78009, 0.78855, 0.80061,  
0.81883, 0.83753, 0.85038, 0.86729, 0.89114,  
0.91981, 0.94812, 0.97334, 0.9925, 1,  
1.01217, 1.03307, 1.05213, 1.06926, 1.08682))

# Adjust price and g_earn for inflation
cfec$year = as.numeric(cfec$year)
cfec$day = substr(cfec$landdate, 6, 10)
cfec$g_price = cfec$g_price/deflationTable$defl[cfec$year-1984]
cfec$g_earn = cfec$g_earn/deflationTable$defl[cfec$year-1984]
```

### Function definiton  
We need to define a few functions for calculating diversity. We'll use the Simpson's diversity index (HHI) to calculate the entropy-based inverse, which is a proxy for effective species diversity. Note the C++ version is commented out below,   

```{r, warning = FALSE, message=FALSE, echo=FALSE}
simp.div = function(x) {
  1/sum((x/sum(x))^2)
}
```

## Filtering out unique vessel - person combinations. Drops rows from 17 to 13 million.   

Now we'll filter out individuals who only used 1 boat in a year, and boats with only one permit holder fishing in a year.  

```{r}
cfecnew = cfec
cfec.1boat = group_by(cfecnew, p_holder, year) %>% 
  summarize(nBoat = length(unique(cadfg))) %>%
  filter(nBoat==1) %>% 
  left_join(cfecnew)

cfecnew = cfec.1boat
dim(cfecnew)[1]
```

## Filtering out people with 10+ years of fishing. Drops rows from 13.7 to 10 million. 
```{r}
cfecnew = group_by(cfecnew, p_holder) %>% 
  mutate(nyr = length(unique(year))) %>% 
  filter(nyr >= 10)
```

## Identify most popular strategies by person-year combination

The top 120 permits cuts the rows down to 8.6 million. The top 50 gets it down to 7.8 million. 
  
```{r}
topstrategies = group_by(cfecnew, p_holder, year) %>% 
  summarize(strategy = paste(sort(unique(p_fshy)), collapse = " ")) %>%
  as.data.frame()
cfecnew = left_join(cfecnew, topstrategies) # adds strategy column

CUTOFF = 50
cfecnew = cfecnew[cfecnew$strategy%in%names(rev(sort(table(topstrategies$strategy)))[1:CUTOFF]), ]
```

Aggregate annual metrics by person, 

```{r}

cfecnew$day = mdy.date(as.numeric(lapply(strsplit(cfecnew$day, "-"), getElement, 1)), as.numeric(lapply(strsplit(cfecnew$day, "-"), getElement, 2)), cfecnew$year) - mdy.date(1, 1, cfecnew$year)

cfecAnnual = group_by(cfecnew, p_holder, year) %>%
  summarize(permit = p_fshy[1], boat = cadfg2[1], 
    days = diff(range(day) + 1), 
    ngear = length(unique(gearn)),
    nspec = length(unique(specn)),
    npermit = length(unique(p_fshy)),
    revenue = sum(g_earn),
    length = mean(VLength, na.rm=T)) 

cfecAnnual = group_by(cfecAnnual, p_holder, year) %>%
  filter(npermit == 1)

# also calculate weighted simpson diversity of gears and species
cfecAnnual = left_join(cfecAnnual, group_by(cfecnew, p_holder, year, specn) %>% 
  summarize(totRev.spec = sum(g_earn)) %>% 
  group_by(p_holder, year) %>% 
  summarize(specDiv = simp.div(totRev.spec)))

# random slope by p_holder
# Random intercepts in people, random intercepts in strategies, random slopes in strategies
# Group level predictors on intercepts 
# Indicator variable for EVOS years. Or whether 

# also calculate weighted simpson diversity of gears and species
cfecAnnual = left_join(cfecAnnual, group_by(cfecnew, p_holder, year, gearn) %>% 
  summarize(totRev.gear = sum(g_earn)) %>% 
  group_by(p_holder, year) %>% 
  summarize(gearDiv = simp.div(totRev.gear)))

#temp = group_by(cfecnew, p_holder, year, specn) %>% 
#  summarize(totRev.spec = sum(g_earn), 
#    permit = p_fshy[1])
#temp = left_join(temp, group_by(cfecnew, p_holder, year) %>% 
#    summarize(totRev = sum(g_earn)))
#temp$totRev.spec = temp$totRev.spec / temp$totRev

#mkt = group_by(cfecnew, p_fshy, year, specn) %>% 
#  summarize(totRev.mkt.spec = sum(g_earn)) 
#mkt = left_join(mkt, group_by(mkt, p_fshy, year) %>% 
#  summarize(totRev.mkt = sum(totRev.mkt.spec))) 
#mkt$totRev.mkt.spec = mkt$totRev.mkt.spec / mkt$totRev.mkt
#names(mkt)[1] = "permit"

# combine individual and market datasets
#temp = left_join(temp, mkt)

# Calculate squared proportions
#temp$p2 = (temp$totRev.spec - temp$totRev.mkt.spec)^2

#cfecAnnual = left_join(cfecAnnual, dplyr::select(temp, p_holder, year, p2))

# Also merge in previous revenue. Idx stores index of people last year
idx = match(paste(cfecAnnual$p_holder,cfecAnnual$year-1), paste(cfecAnnual$p_holder,cfecAnnual$year))

cfecAnnual$permit.prev = cfecAnnual$permit[idx]
cfecAnnual$ngear.prev = cfecAnnual$ngear[idx]
cfecAnnual$nspec.prev = cfecAnnual$nspec[idx]
cfecAnnual$npermit.prev = cfecAnnual$npermit[idx]
cfecAnnual$revenue.prev = cfecAnnual$revenue[idx]
cfecAnnual$specdiv.prev = cfecAnnual$specDiv[idx]
cfecAnnual$geardiv.prev = cfecAnnual$gearDiv[idx]
#cfecAnnual$p2.prev = cfecAnnual$p2[idx]

cfecAnnual$specDiv.change = cfecAnnual$specDiv - cfecAnnual$specdiv.prev

# Filter out salmon people
cfecAnnual$salmon = ifelse(substr(cfecAnnual$permit,1,1)=="S", "Y", "N")

cfecAnnual.salmon = cfecAnnual[cfecAnnual$salmon=="Y",]
cfecAnnual.nonsalmon = cfecAnnual[cfecAnnual$salmon=="N",]

cfecAnnual.salmon = cfecAnnual.salmon[is.na(cfecAnnual.salmon$specDiv.change)==F, ]
cfecAnnual.nonsalmon = cfecAnnual.nonsalmon[is.na(cfecAnnual.nonsalmon$specDiv.change)==F, ]

saveRDS(cfecAnnual.salmon, file="salmon_linearModeling_complete.rds")
saveRDS(cfecAnnual.nonsalmon, file="nonsalmon_linearModeling_complete.rds")

```

## Do some exploration by permit types + diversity

For example, when someone is diversifying with a herring, halibut, or crab permit, what does that diversification look like?

```{r, echo=FALSE}
cfecnew$taxa = substr(cfecnew$p_fshy, 1, 1)
specPermit = group_by(cfecnew, taxa, specn) %>% 
  summarize(percent.revenue = sum(g_earn))
specPermit.tot = group_by(specPermit, taxa) %>% 
  summarize(tot = sum(percent.revenue))
specPermit = left_join(specPermit, specPermit.tot)
specPermit$percent.revenue = specPermit$percent.revenue/specPermit$tot
specPermit.df = group_by(specPermit, taxa, specn) %>% 
  filter(percent.revenue > 0.02) %>% 
  arrange(taxa) %>% 
  as.data.frame
specPermit.df$spec = cfec$spec[match(specPermit.df$specn, cfec$specn)]
kable(specPermit.df)
```

## Code for looking at permit 
We can look at whether there's clear combinations of permit types that are combinations -- most of these people either have a single local permit (PWS, Bristol Bay, etc) or have multiple statewide permits. 

```{r}

cfecnew$area = substr(cfecnew$p_fshy,4,4)
cfecnew$area[cfecnew$area %in% c("A","C")] = "Southeast"
cfecnew$area[cfecnew$area == "B"] = "Statewide"
cfecnew$area[cfecnew$area == "D"] = "Yakutat"
cfecnew$area[cfecnew$area == "E"] = "PWS"
cfecnew$area[cfecnew$area == "H"] = "CookInlet"
cfecnew$area[cfecnew$area == "J"] = "Westward"
cfecnew$area[cfecnew$area == "K"] = "Kodiak"
cfecnew$area[cfecnew$area == "L"] = "Chignik"
cfecnew$area[cfecnew$area == "M"] = "AlaskaPeninsula"
cfecnew$area[cfecnew$area == "N"] = "Nelson"
cfecnew$area[cfecnew$area == "Q"] = "BeringSea"
cfecnew$area[cfecnew$area == "T"] = "BristolBay"
cfecnew$area[cfecnew$area == "X"] = "Kotzebue"
cfecnew$area[cfecnew$area == "Z"] = "NortonSound"

cfecnew$spec = substr(cfecnew$p_fshy,1,1)
cfecnew$spec[cfecnew$spec == "B"] = "Halibut"
cfecnew$spec[cfecnew$spec == "C"] = "Sablefish"
cfecnew$spec[cfecnew$spec %in% c("D","E","K","T")] = "Crab"
cfecnew$spec[cfecnew$spec %in% c("F")] = "Freshwater"
cfecnew$spec[cfecnew$spec %in% c("G","H","L")] = "Herring"
cfecnew$spec[cfecnew$spec %in% c("I")] = "Lingcod"
cfecnew$spec[cfecnew$spec %in% c("A","J","N","R","W")] = "Shellfish"
cfecnew$spec[cfecnew$spec %in% c("O","P","Q","U","Z")] = "Invert"
cfecnew$spec[cfecnew$spec %in% c("M")] = "Misc"
cfecnew$spec[cfecnew$spec %in% c("S")] = "Salmon"
cfecnew$area.spec = paste(cfecnew$area, cfecnew$spec, sep="_")

cfecAnnual.multiplePermits = group_by(cfecnew, p_holder, year) %>%
  summarize(npermit = length(unique(p_fshy)), 
    allpermits = paste(sort(unique(p_fshy)), collapse = " "),
    areaspec = paste(sort(unique(area.spec)), collapse = " ")) %>%
  filter(npermit > 1)

```


