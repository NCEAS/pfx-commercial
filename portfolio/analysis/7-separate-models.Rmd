---
title: "Analysis of variability"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, autodep = TRUE, warning = FALSE)
```

Let's take a look at the simpler model that uses the CV of revenue for each permit holder as a response. If our more complicated models with structure in the error term are doing what we think then we should be able to replicate similar conclusions.

```{r load-data}
library(dplyr)
library(ggplot2)
library(lme4)
dm <- readRDS("../data-generated/cfec-annual-for-modeling.rds")
nrow(dm)
```

We'll filter the data to keep permit holders that fished for at least ten years. We'll also have to filter out any permit holders that have no variability in the diversity fished.

```{r filter-data}
dm <- group_by(dm, p_holder) %>%
  mutate(nyr = length(unique(year))) %>%
  mutate(range_div = diff(range(specDiv))) %>%
  as_data_frame() %>%
  filter(nyr >= 5) %>%
  filter(range_div > 0)
nrow(dm)

# # we don't need to crop the strategies at this point
# top.strategies = names(rev(sort(table(dm$strategy)))[1:100])
# dm = dm[dm$strategy%in%top.strategies, ]
# nrow(dm)

dm$log_spec_div <- scale(log(dm$specDiv))
dm$log_length <- scale(log(dm$length + 1))
dm$log_weight <- scale(log(dm$weight + 1))
dm$log_days <- scale(log(dm$days + 1))
```

We'll consider strategies taxonomic groups here and keep all strategies that have at least 5 permit holders.

```{r condense-data-by-permit-holder}
dmv <- dm %>% group_by(p_holder) %>%
  summarise(cv = sd(revenue)/mean(revenue), log_specDiv = mean(log(specDiv)),
    # summarise(cv = mean(revenue), log_specDiv = mean(log(specDiv)),
    length = mean(log(length+1), na.rm = TRUE), days = mean(days, na.rm = TRUE),
    strategy = paste(sort(unique(substr(strategy, 1, 1))), collapse = " ")) %>%
  as_data_frame() %>%
  group_by(strategy) %>%
  mutate(n_strategy = n()) %>%
  filter(n_strategy > 4) %>%
  mutate(mean_log_spec = mean(log_specDiv)) %>%
  as_data_frame() %>%
  mutate(scaled_log_days = scale(log(days + 1)), scaled_log_spec = scale(log_specDiv),
    scaled_log_length = scale(length))
dmv$strategy <- as.factor(dmv$strategy)
```

This is how much the last step filtered out.

```{r check-n}
length(unique(dm$p_holder))
nrow(dmv)
# dmv <- na.omit(dmv) # some permit holders are lacking vessel length 
# nrow(dmv)
```

Note that we are losing the most permit holders by needing to have data for vessel length.

We'll fit a model with `lmer()`.

```{r fit-model}
# m3 <- lmer(log(cv) ~ scaled_log_spec + scaled_log_days + scale(I(log_specDiv^2)) +
#     (1 + scaled_log_spec+scale(I(log_specDiv^2))|strategy), data = dmv)

# m3 <- lmer(log(cv) ~ scaled_log_spec + scaled_log_days + scaled_log_length +
#     (1 + (scaled_log_spec + scaled_log_days + scaled_log_length)|strategy), data = dmv)

    # scale(I(log_specDiv^2)) +

# m4 <- lmer(log(cv) ~ (scaled_log_spec+scaled_log_days+scaled_log_length)^2 + 
#     (1 + (scaled_log_spec+scaled_log_days+scaled_log_length)^2|strategy), data = dmv)

m4 <- lmer(log(cv) ~ (scaled_log_spec+scaled_log_days)^2 + 
    (1 + (scaled_log_spec+scaled_log_days)^2|strategy), data = dmv)
```

```{r extract-coefficients}
co <- coef(m4)$strategy
co$strategy <- row.names(co)
# names(co)[1:4] <- c("intercept", "log_diversity", "log_days", "strategy")
# arm::display(m4)
# summary(m4)
```

Let's look at the residuals in a few ways.

```{r check-residuals-groups, fig.width=12, fig.height=9}
dmv$residuals <- residuals(m4)
dmv %>%
  arrange(strategy, log_specDiv) %>%
  ggplot(aes(scaled_log_spec, residuals, color = scaled_log_days)) + facet_wrap(~strategy) +
  geom_point(alpha = 0.7) +
  geom_smooth(se = FALSE, color = "grey50")
```

These look pretty good with the exception that we might be missing a quadratic effect of species diversity for the strategies involving salmon (`S`). See the curve downward towards the right in the panels that include salmon, especially the salmon-only panel. 

```{r check-residuals}
dmv %>%
  arrange(strategy, log_specDiv) %>%
  ggplot(aes(scaled_log_spec, residuals, color = scaled_log_days)) + 
  geom_point(alpha = 0.1) +
  geom_smooth(se = FALSE, color = "grey50")
```

```{r check-residuals-fitted, fig.width=12, fig.height=9}
dmv$fitted <- fitted(m4)
dmv %>%
  ggplot(aes(fitted, residuals, color = scaled_log_spec)) + facet_wrap(~strategy) +
  geom_point(alpha = 0.7) +
  geom_smooth(se = FALSE, color = "grey50")
```

These look pretty good with the exception of the `G S` (herring-salmon) and `S` (salmon-only) where we are under predicting CV in some cases where there is actually high CV.

Across permit holder effects:

```{r coefficient-plot}
broom::tidy(m4, conf.int = TRUE) %>%
  filter(term != "(Intercept)") %>%
  filter(!grepl("cor_", term)) %>%
  mutate(conf.low = ifelse(is.na(std.error), estimate, conf.low)) %>%
  mutate(conf.high = ifelse(is.na(std.error), estimate, conf.high)) %>%
  ggplot(aes(y = estimate, ymax = conf.low, ymin = conf.high, x = term)) +
  geom_pointrange() +
  coord_flip() +
  geom_hline(yintercept = 0, lty = 2)
```

What I see:

- increased diversity = lower variability (somewhat quadratically for those including salmon in their strategy)
- longer fishing seasons = lower variability
- benefit of diversifying is much greater for those with longer fishing seasons

Across strategy effects:

```{r group-level-predictors, fig.width=10, fig.height=8}
co <- mutate(co, salmon = grepl("S", strategy))

co_strategy_long <- tidyr::gather(co, parameter, estimate, -salmon, -strategy) %>%
  inner_join(select(dmv, strategy, mean_log_spec) %>% unique())

ggplot(co_strategy_long, aes(mean_log_spec, estimate, label = strategy, color = salmon)) +
  geom_text(size = 3) +
  facet_wrap(~parameter, scales = "free_x") +
  geom_hline(yintercept = 0, lty = 2) +
  geom_smooth(method = "lm", se = FALSE)
```

What I see:

- strategies with higher mean diversity may have very slightly higher CV (but see below where that isn't as clear across most strategy groups)
- strategies with higher mean diversity have more benefit to diversifying if salmon is included in the strategy (this remains consistent across the groups in the below figure)

```{r group-level-predictors-grouped, fig.width=14, fig.height=7}
strategy_grouped <- rbind(cbind(co_strategy_long[grep("M",co_strategy_long$strategy),], group="Groundfish"),
  cbind(co_strategy_long[grep("S",co_strategy_long$strategy),], group="Salmon"),
  cbind(co_strategy_long[grep("B|C",co_strategy_long$strategy),], group="Halibut-Sablefish"),
  cbind(co_strategy_long[grep("K|T|D",co_strategy_long$strategy),], group="Crab"),
  cbind(co_strategy_long[grep("G",co_strategy_long$strategy),], group="Herring"))

strategy_grouped <- filter(strategy_grouped, 
  parameter %in% c("(Intercept)", "scaled_log_days", "scaled_log_spec"))
ggplot(strategy_grouped, aes(mean_log_spec, estimate, label = strategy)) +
  geom_text() + geom_smooth(se = FALSE, method = "lm") +
  geom_hline(yintercept = 0, lty = 2) +
  facet_grid(parameter~group, scales = "free_y")

```

