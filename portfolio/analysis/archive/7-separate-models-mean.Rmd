---
title: "Analysis of revenue"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, autodep=TRUE, warning = TRUE)
```


```{r load-data}
library(dplyr)
library(ggplot2)
library(lme4)
dm <- readRDS("../data-generated/cfec-annual-for-modeling.rds")
nrow(dm)
```

We'll filter the data to keep permit holders that fished for at least ten years. We'll also have to filter out any permit holders that have no variability in the diversity fished.

```{r filter-data}
dm <- group_by(dm, p_holder) %>%
  mutate(nyr = length(unique(year))) %>%
  mutate(range_div = diff(range(specDiv))) %>%
  as_data_frame() %>%
  filter(nyr >= 10) %>%
  filter(range_div > 0)
nrow(dm)

top.strategies = names(rev(sort(table(dm$strategy)))[1:100])
dm = dm[dm$strategy%in%top.strategies, ]
nrow(dm)

dm_holder <- group_by(dm, p_holder) %>%
  summarize(mean_diversity = mean(log(specDiv)))%>%
  mutate(p_holder = as.character(p_holder)) %>%
  unique

dm_strategy <- group_by(dm, strategy) %>%
  summarize(mean_diversity = mean(log(specDiv))) %>%
  unique

holder_strategy <- select(dm, strategy, p_holder) %>% distinct() %>%
  mutate(p_holder = as.character(p_holder))

dm$log_spec_div <- scale(log(dm$specDiv))
dm$log_length <- scale(log(dm$length + 1))
dm$log_weight <- scale(log(dm$weight + 1))
dm$log_days <- scale(log(dm$days + 1))
```

We'll fit a model with `lmer()`.

```{r fit-models}
# m5 <- lmer(log(revenue) ~ log_spec_div * log_days * log_length +
#     (1 + log_spec_div|strategy) + (1 + log_spec_div|p_holder), data = dm)
m5 <- lmer(log(revenue) ~ (log_spec_div + log_days + log_length)^2 +
    (1 + (log_spec_div + log_days + log_length)|strategy) + 
    (1 + log_spec_div|p_holder), data = dm)
```

```{r extract-coefficients}
co_strategy <- coef(m5)$strategy
co_strategy$strategy <- row.names(co_strategy)

co_holder <- coef(m5)$p_holder
co_holder$p_holder <- row.names(co_holder)

# arm::display(m5)
# print(m5, digits = 2)
# summary(m5)
```

For a given permit holder effects:

```{r plot-coefficients}
broom::tidy(m5, conf.int = TRUE) %>%
  filter(term != "(Intercept)") %>%
  filter(!grepl("cor_", term)) %>%
  mutate(conf.low = ifelse(is.na(std.error), estimate, conf.low)) %>%
  mutate(conf.high = ifelse(is.na(std.error), estimate, conf.high)) %>%
  ggplot(aes(y = estimate, ymax = conf.low, ymin = conf.high, x = term)) +
  geom_pointrange() +
  coord_flip() +
  geom_hline(yintercept = 0, lty = 2)
```

What I see:

- increased diversity = lower revenue
- longer boats make more money (obviously)s
- longer seasons = more money (obviously)
- no major interaction effects for these 3 predictors

Now let's look at across permit holder effects:

```{r plot-holder-level-coefficients, fig.width=13, fig.height=6}
co_holder_long <- tidyr::gather(co_holder, parameter, estimate, -p_holder) %>%
  filter(parameter %in% c("(Intercept)", "log_spec_div")) %>%
  inner_join(dm_holder) %>%
  inner_join(holder_strategy)

strategy_grouped <- rbind(cbind(co_holder_long[grep("M",co_holder_long$strategy),], group="Groundfish"),
  cbind(co_holder_long[grep("S",co_holder_long$strategy),], group="Salmon"),
  cbind(co_holder_long[grep("B|C",co_holder_long$strategy),], group="Halibut-Sablefish"),
  cbind(co_holder_long[grep("K|T|D",co_holder_long$strategy),], group="Crab"),
  cbind(co_holder_long[grep("G",co_holder_long$strategy),], group="Herring"))

strategy_grouped <- mutate(strategy_grouped, 
  salmon = ifelse(grepl("S", strategy), TRUE, FALSE))
ggplot(strategy_grouped, aes(mean_diversity, estimate, color = salmon)) +
  geom_point(alpha = 0.1) +
  facet_grid(parameter~group, scales = "free_y") +
  geom_smooth(method = "lm", se = FALSE)
```

What I see:

- permit holders with higher mean diversity on average make slightly more money
- the variability around this relationship becomes tighter at higher levels of mean diversity
- not much change in the cost of diversifying across permit holders with different mean diversity levels

Now let's look at across strategy effects:

```{r plot-strategy-level-coefficients, fig.width=13, fig.height=6}
co_strategy_long <- tidyr::gather(co_strategy, parameter, estimate, -strategy) %>%
  filter(parameter %in% c("(Intercept)", "log_spec_div")) %>%
  inner_join(dm_strategy)

strategy_grouped <- rbind(cbind(co_strategy_long[grep("M",co_strategy_long$strategy),], group="Groundfish"),
  cbind(co_strategy_long[grep("S",co_strategy_long$strategy),], group="Salmon"),
  cbind(co_strategy_long[grep("B|C",co_strategy_long$strategy),], group="Halibut-Sablefish"),
  cbind(co_strategy_long[grep("K|T|D",co_strategy_long$strategy),], group="Crab"),
  cbind(co_strategy_long[grep("G",co_strategy_long$strategy),], group="Herring"))

strategy_grouped <- mutate(strategy_grouped, 
  salmon = ifelse(grepl("S", strategy), TRUE, FALSE))

ggplot(strategy_grouped, aes(mean_diversity, estimate, label = strategy, color = salmon)) +
  geom_text() + geom_smooth(se = FALSE, method = "lm") +
  facet_grid(parameter~group, scales = "free_y")
```

What I see:

- strategies with higher mean diversity on average make more money, especially if salmon are amongst the strategy 
- for some groupings, strategies with higher mean diversity have less of a diversifying cost (especially for salmon only, salmon plus crab, and salmon plus herring)
